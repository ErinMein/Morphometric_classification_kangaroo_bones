---
title: "Macropod Astragalus - Metric morphometrics"
author: "Erin Mein"
date: "04/03/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---
#Description of analyses
#This analysis includes multivariate ordinal and statistical analyses of macropod astragali and models the classification of archaeological specimens from Boodie Cave, Barrow Island, Western Australia.

```{r set library and wd}
library(MASS)
library(tidyverse)
library(car)
library(plyr)
library(Hmisc)
library(vegan)
library(rstatix)
library(MVN)
library(psych)

setwd("~/##sET WD ##/Morphometric_classification_kangaroo_bones/Astragali")
```

```{r Test Intraoperator Error}
astragalus <- read.csv("Data/Raw.test.retest.csv")

H_nf1 <- ICC(astragalus[1:65,6:8])
H_nf2 <- ICC(astragalus[66:123,6:8])
H_nf3 <- ICC(astragalus[124:181,6:8])
H_nf <- data.frame(c('H_nf', H_nf1$results[3,2:6], H_nf2$results[3,2:6], H_nf3$results[3,2:6]))
colnames(H_nf)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(H_nf1, H_nf2, H_nf3)

B_nf1 <- ICC(astragalus[1:65,9:11])
B_nf2 <- ICC(astragalus[66:123,9:11])
B_nf3 <- ICC(astragalus[124:181,9:11])
B_nf <- data.frame(c('B_nf', B_nf1$results[3,2:6], B_nf2$results[3,2:6], B_nf3$results[3,2:6]))
colnames(B_nf)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(B_nf1, B_nf2, B_nf3)

L_mtc1 <- ICC(astragalus[1:65,12:14])
L_mtc2 <- ICC(astragalus[66:123,12:14])
L_mtc3 <- ICC(astragalus[124:181,12:14])
L_mtc <- data.frame(c('L_mtc', L_mtc1$results[3,2:6], L_mtc2$results[3,2:6], L_mtc3$results[3,2:6]))
colnames(L_mtc)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(L_mtc1, L_mtc2, L_mtc3)

L_ltc1 <- ICC(astragalus[1:65,15:17])
L_ltc2 <- ICC(astragalus[66:123,15:17])
L_ltc3 <- ICC(astragalus[124:181,15:17])
L_ltc <- data.frame(c('L_ltc', L_ltc1$results[3,2:6], L_ltc2$results[3,2:6], L_ltc3$results[3,2:6]))
colnames(L_ltc)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(L_ltc1, L_ltc2, L_ltc3)

B_atc1 <- ICC(astragalus[1:65,18:20])
B_atc2 <- ICC(astragalus[66:123,18:20])
B_atc3 <- ICC(astragalus[124:181,18:20])
B_atc <- data.frame(c('B_atc', B_atc1$results[3,2:6], B_atc2$results[3,2:6], B_atc3$results[3,2:6]))
colnames(B_atc)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(B_atc1, B_atc2, B_atc3)

B_ptc1 <- ICC(astragalus[1:65,21:23])
B_ptc2 <- ICC(astragalus[66:123,21:23])
B_ptc3 <- ICC(astragalus[124:181,21:23])
B_ptc <- data.frame(c('B_ptc', B_ptc1$results[3,2:6], B_ptc2$results[3,2:6], B_ptc3$results[3,2:6]))
colnames(B_ptc)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(B_ptc1, B_ptc2, B_ptc3)

B_t1 <- ICC(astragalus[1:65,24:26])
B_t2 <- ICC(astragalus[66:123,24:26])
B_t3 <- ICC(astragalus[124:181,24:26])
B_t <- data.frame(c('B_t', B_t1$results[3,2:6], B_t2$results[3,2:6], B_t3$results[3,2:6]))
colnames(B_t)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(B_t1, B_t2, B_t3)

B_mTaCa1 <- ICC(astragalus[1:65,27:29])
B_mTaCa2 <- ICC(astragalus[66:123,27:29])
B_mTaCa3 <- ICC(astragalus[124:181,27:29])
B_mTaCa <- data.frame(c('B_mTaCa', B_mTaCa1$results[3,2:6], B_mTaCa2$results[3,2:6], B_mTaCa3$results[3,2:6]))
colnames(B_mTaCa)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(B_mTaCa1, B_mTaCa2, B_mTaCa3)

H_mTaCa1 <- ICC(astragalus[1:65,30:32])
H_mTaCa2 <- ICC(astragalus[66:123,30:32])
H_mTaCa3 <- ICC(astragalus[124:181,30:32])
H_mTaCa <- data.frame(c('H_mTaCa', H_mTaCa1$results[3,2:6], H_mTaCa2$results[3,2:6], H_mTaCa3$results[3,2:6]))
colnames(H_mTaCa)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(H_mTaCa1, H_mTaCa2, H_mTaCa3)

B_lTaCa1 <- ICC(astragalus[1:65,33:35])
B_lTaCa2 <- ICC(astragalus[66:123,33:35])
B_lTaCa3 <- ICC(astragalus[124:181,33:35])
B_lTaCa <- data.frame(c('B_lTaCa', B_lTaCa1$results[3,2:6], B_lTaCa2$results[3,2:6], B_lTaCa3$results[3,2:6]))
colnames(B_lTaCa)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(B_lTaCa1, B_lTaCa2, B_lTaCa3, tmp)

L_lTaCa1 <- ICC(astragalus[1:65,36:38])
L_lTaCa2 <- ICC(astragalus[66:123,36:38])
L_lTaCa3 <- ICC(astragalus[124:181,36:38])
L_lTaCa <- data.frame(c('L_lTaCa', L_lTaCa1$results[3,2:6], L_lTaCa2$results[3,2:6], L_lTaCa3$results[3,2:6]))
colnames(L_lTaCa)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(L_lTaCa1, L_lTaCa2, L_lTaCa3)

L_tn1 <- ICC(astragalus[1:65,39:41])
L_tn2 <- ICC(astragalus[66:123,39:41])
L_tn3 <- ICC(astragalus[124:181,39:41])
L_tn <- data.frame(c('L_tn', L_tn1$results[3,2:6], L_tn2$results[3,2:6], L_tn3$results[3,2:6]))
colnames(L_tn)[1:16] <- c("Variable","r.large", "F.large", "df1.large", "df2.large", "p.large", "r.medium", "F.medium", "df1.medium", "df2.medium", "p.medium", "r.small", "F.small", "df1.small", "df2.small", "p.small")
remove(L_tn1, L_tn2, L_tn3)

Astragalus_Rep <- rbind(H_nf, B_nf, L_mtc, L_ltc, B_atc, B_ptc, B_t, B_mTaCa, H_mTaCa, B_lTaCa, L_lTaCa, L_tn)
remove(H_nf, B_nf, L_mtc, L_ltc, B_atc, B_ptc, B_t, B_mTaCa, H_mTaCa, B_lTaCa, L_lTaCa, L_tn)

#Mean Standard Deviation as % of Mean by Size Group
astragalus <- astragalus[complete.cases(astragalus[,6:41]),]
H_nf <- (apply(astragalus[,6:8], 1, sd))/(rowMeans(astragalus[,6:8]))
B_nf <- (apply(astragalus[,9:11], 1, sd))/(rowMeans(astragalus[,9:11]))
L_mtc <- (apply(astragalus[,12:14], 1, sd))/(rowMeans(astragalus[,12:14]))
L_ltc <- (apply(astragalus[,15:17], 1, sd))/(rowMeans(astragalus[,15:17]))
B_atc <- (apply(astragalus[,18:20], 1, sd))/(rowMeans(astragalus[,18:20]))
B_ptc <- (apply(astragalus[,21:23], 1, sd))/(rowMeans(astragalus[,21:23]))
B_t <- (apply(astragalus[,24:26], 1, sd))/(rowMeans(astragalus[,24:26]))
B_mTaCa <- (apply(astragalus[,27:29], 1, sd))/(rowMeans(astragalus[,27:29]))
H_mTaCa <- (apply(astragalus[,30:32], 1, sd))/(rowMeans(astragalus[,30:32]))
B_lTaCa <- (apply(astragalus[,33:35], 1, sd))/(rowMeans(astragalus[,33:35]))
L_lTaCa <- (apply(astragalus[,36:38], 1, sd))/(rowMeans(astragalus[,36:38]))
L_tn <- (apply(astragalus[,39:41], 1, sd))/(rowMeans(astragalus[,39:41]))
AstragalusPC <- data.frame('Variable' = character(0),'Large'=integer(0), "Medium" = integer(0), 'Small' = integer())
AstragalusPC[1,] <- rbind(AstragalusPC, c("H_nf", round(mean(H_nf[1:62]),3), round(mean(H_nf[63:117]),3), round(mean(H_nf[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("B_nf", round(mean(B_nf[1:62]),3), round(mean(B_nf[63:117]),3), round(mean(B_nf[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("L_mtc", round(mean(L_mtc[1:62]),3), round(mean(L_mtc[63:117]),3), round(mean(L_mtc[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("L_ltc", round(mean(L_ltc[1:62]),3), round(mean(L_ltc[63:117]),3), round(mean(L_ltc[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("B_atc", round(mean(B_atc[1:62]),3), round(mean(B_atc[63:117]),3), round(mean(B_atc[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("B_ptc", round(mean(B_ptc[1:62]),3), round(mean(B_ptc[63:117]),3), round(mean(B_ptc[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("B_t", round(mean(B_t[1:62]),3), round(mean(B_t[63:117]),3), round(mean(B_t[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("B_mTaCa", round(mean(B_mTaCa[1:62]),3), round(mean(B_mTaCa[63:117]),3), round(mean(B_mTaCa[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("H_mTaCa", round(mean(H_mTaCa[1:62]),3), round(mean(H_mTaCa[63:117]),3), round(mean(H_mTaCa[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("B_lTaCa", round(mean(B_lTaCa[1:62]),3), round(mean(B_lTaCa[63:117]),3), round(mean(B_lTaCa[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("L_lTaCa", round(mean(L_lTaCa[1:62]),3), round(mean(L_lTaCa[63:117]),3), round(mean(L_lTaCa[118:169]),3)))
AstragalusPC <- rbind(AstragalusPC, c("L_tn", round(mean(L_tn[1:62]),3), round(mean(L_tn[63:117]),3), round(mean(L_tn[118:169]),3)))
AstragalusPC
remove(H_nf, B_nf, L_mtc, L_ltc, B_atc, B_ptc, B_t, B_mTaCa, H_mTaCa, B_lTaCa, L_lTaCa, L_tn)

write.csv(AstragalusPC, "Supp_Tables/Table.S6.1A.csv")
write.csv(Astragalus_Rep, "Supp_Tables/Table.S6.1B.csv")
```


```{r Import Training data}
Data.train <- read.csv(file="Data/Data.train.final.csv", header=TRUE)
rownames(Data.train) <- c(paste(substr(Data.train$Genus,1,1),substr(Data.train$Species,1,3), Data.train$Specimen_ID ,sep = "_"))
```

```{r Test for Redundancy}
redun(~Data.train[, 9] + Data.train[, 10] + Data.train[, 11] + Data.train[, 12] + 
    Data.train[, 13] + Data.train[, 14] + Data.train[, 15] + Data.train[, 
    16] + Data.train[, 17] + Data.train[, 18] + Data.train[, 19] + Data.train[, 
    20], r2 = 0.01)

PCA <- prcomp(Data.train[,9:20])
PCAredun <- prcomp(Data.train[,c(10, 13, 16:20)])

PCA_distance <- dist(PCA$x)
PCAredun_dist <- dist(PCAredun$x)

mantel(PCA_distance, PCAredun_dist, method = "pearson", permutations = 9999)

remove(PCA, PCAredun, PCA_distance, PCAredun_dist)
```

```{r Remove redundant variables from training data}
Data.train <- Data.train[,c(1:5, 7, 8, 10, 13, 16:20)]
colnames(Data.train)
```

```{r calculate Geometric Mean & standardise data using Log Shape Ratio method (Claude 2013)}
GeoMean <- apply(Data.train[,8:14], 1, prod)^(1/7)
LSR.train <- log(Data.train[,8:14]/ GeoMean)
LSR.train <- cbind(Data.train[,1:7], GeoMean, LSR.train)
remove(GeoMean)
```

```{r Apply Size Categories to Training Data}
Size <- Data.train$Group
Size <- gsub("Burrowing bettong", "Small", Size)
Size <- gsub("Brush-tailed bettong", "Small", Size)
Size <- gsub("Spectacled hare-wallaby", "Medium", Size)
Size <- gsub("Rufous hare-wallaby", "Small", Size)
Size <- gsub("Banded hare-wallaby", "Small", Size)
Size <- gsub("W. grey kangaroo", "Large", Size)
Size <- gsub("Agile wallaby", "Large", Size)
Size <- gsub("Bridled nail-tail wallaby", "Medium", Size)
Size <- gsub("Northern nail-tail wallaby", "Medium", Size)
Size <- gsub("Black wallaroo", "Large", Size)
Size <- gsub("Antilopine wallaroo", "Large", Size)
Size <- gsub("Common wallaroo", "Large", Size)
Size <- gsub("Red kangaroo", "Large", Size)
Size <- gsub("Short-eared rock-wallaby", "Medium", Size)
Size <- gsub("Nabarlek", "Small", Size)
Size <- gsub("Black-flanked rock-wallaby", "Medium", Size)
Size <- gsub("Rothschild's rock-wallaby", "Medium", Size)

Data.train <- cbind(Data.train[,1:6], Size, Data.train[7:14])
LSR.train <- cbind(LSR.train[,1:6], Size, LSR.train[,7:15])
remove(Size)
```

```{r Import Archaeological Data}
Data.arch <- read.csv(file="Data/Data.arch.csv", header=TRUE)
rownames(Data.arch) <- c(paste(substr(Data.arch$Genus,1,1),substr(Data.arch$Species,1,3), Data.arch$Specimen_ID ,sep = "_"))

```

```{r Calculate Size of Archaeological Specimens & Compare with training data}
GeoMean <- apply(Data.arch[,9:15], 1, prod)^(1/7)
LSR.arch <- log(Data.arch[,9:15]/ GeoMean)
LSR.arch <- cbind(Data.arch[,1:8], GeoMean, LSR.arch)

colnames(LSR.arch) == colnames(LSR.train)
remove(GeoMean)

LSR.all <- rbind(LSR.train, LSR.arch)
```

```{r Plot size of arch and training data}
tmp <- LSR.train[,c(7,8,9)]
new_order <- with(tmp, reorder(Group , GeoMean, median , na.rm=T))
tmparch <- LSR.arch[,c(3, 9)]

boxplot(tmp$GeoMean ~ new_order,las = 2, ylab = '', xlab = "", col = 'white')
abline(a=tmparch$GeoMean[1], b= 0, col=alpha("black", 0.2), lwd = 1) #"BC004"
abline(a=tmparch$GeoMean[2], b= 0, col=alpha("black", 0.2), lwd = 1) #BC042
abline(a=tmparch$GeoMean[3], b= 0, col=alpha("black", 0.2), lwd = 1) #BC044
abline(a=tmparch$GeoMean[4], b= 0, col=alpha("black", 0.2), lwd = 1) #BC048
abline(a=tmparch$GeoMean[5], b= 0, col=alpha("black", 0.2), lwd = 1) #BC062
abline(a=tmparch$GeoMean[6], b= 0, col=alpha("black", 0.2), lwd = 1) #BC142
abline(a=tmparch$GeoMean[7], b= 0, col=alpha("black", 0.2), lwd = 1) #BC170
abline(a=tmparch$GeoMean[8], b= 0, col=alpha("black", 0.2), lwd = 1) #BC211
abline(a=tmparch$GeoMean[9], b= 0, col=alpha("black", 0.2), lwd = 1) #BC212
abline(a=tmparch$GeoMean[10], b= 0, col=alpha("black", 0.2), lwd = 1) #BC224
abline(a=tmparch$GeoMean[11], b= 0, col=alpha("black", 0.2), lwd = 1) #BC293
abline(a=tmparch$GeoMean[12], b= 0, col=alpha("black", 0.2), lwd = 1) #BC294
abline(a=tmparch$GeoMean[13], b= 0, col=alpha("black", 0.2), lwd = 1) #BC337

remove(tmp, tmparch, new_order)
```

```{r Split Training Data & Archaeological Data into Size Classes}

LSR.Large <- rbind(filter(LSR.all, Size == "Large"), filter(LSR.all, Group == "Northern nail-tail wallaby"))

tmp <- filter(LSR.arch, GeoMean > 3.5)
LSR.Medium <- rbind(filter(LSR.all, Size == "Medium"), tmp)

tmp <- filter(LSR.arch, GeoMean < 3.5)
LSR.Small <- rbind(filter(LSR.all, Size == "Small"), filter(LSR.all, Group == "Spectacled hare-wallaby"), tmp)

```

##Large Macropod PCA

```{r Create Factors}
Largespc <- LSR.Large$Group
Largespc <- gsub("W. grey kangaroo", "#FF6633", Largespc)
Largespc <- gsub("Agile wallaby", "#0000FF", Largespc)
Largespc <- gsub("Northern nail-tail wallaby", "#FFFF00", Largespc)
Largespc <- gsub("Black wallaroo", "#99CC00", Largespc)
Largespc <- gsub("Antilopine wallaroo", "#009966", Largespc)
Largespc <- gsub("Common wallaroo", "#00FF00", Largespc)
Largespc <- gsub("Red kangaroo", "#006600", Largespc)
Largespc

Largeage <- LSR.Large$Age
Largeage <- (gsub("Juvenile", 18, Largeage))
Largeage <- (gsub("Subadult", 17, Largeage))
Largeage <- (gsub("Adult", 16, Largeage))
Largeage <- ifelse(Largeage <16, 15, Largeage)
Largeage <- ifelse(Largeage >18, 15, Largeage)
Largeage <- ifelse(is.na(Largeage), 15, Largeage)
Largeage <- as.numeric(Largeage)
Largeage
```

```{r #Plot PC1 vs PC2}
PCA <- prcomp(LSR.Large[,10:16])
sum.PCA <- summary(PCA)

chull <- cbind(LSR.Large[,1:8], PCA$x[,1:2])
polys <- ddply(chull, .(Group), function(chull) chull[chull(chull$PC1, chull$PC2), ])

plot(PCA$x[,2] ~ PCA$x[,1], 
     pch=Largeage,
     col=Largespc,
     xlab=paste("PC 1 (", round(sum.PCA$importance[2]*100, 1), "%)", sep = ""), 
     ylab=paste("PC 2 (", round(sum.PCA$importance[5]*100, 1), "%)", sep = ""), 
     asp=1, 
     cex=3)

polygon(c(polys$PC1[polys$Group=="W. grey kangaroo"]), c(polys$PC2[polys$Group=="W. grey kangaroo"]), col = alpha("#FF6633", 0.2), border = "#FF6633")
polygon(c(polys$PC1[polys$Group=="Agile wallaby"]), c(polys$PC2[polys$Group=="Agile wallaby"]), col = alpha("#0000FF", 0.2), border = "#0000FF")
polygon(c(polys$PC1[polys$Group=="Antilopine wallaroo"]), c(polys$PC2[polys$Group=="Antilopine wallaroo"]), col = alpha("#009966", 0.2), border = "#009966")
polygon(c(polys$PC1[polys$Group=="Common wallaroo"]), c(polys$PC2[polys$Group=="Common wallaroo"]), col = alpha("#00FF00", 0.2), border = "#00FF00")
polygon(c(polys$PC1[polys$Group=="Red kangaroo"]), c(polys$PC2[polys$Group=="Red kangaroo"]), col = alpha("#006600", 0.2), border = "#006600")
polygon(c(polys$PC1[polys$Group=="Northern nail-tail wallaby"]), c(polys$PC2[polys$Group=="Northern nail-tail wallaby"]), col = alpha("#FFFF00", 0.2), border = "#FFFF00")
polygon(c(polys$PC1[polys$Group=="Black wallaroo"]), c(polys$PC2[polys$Group=="Black wallaroo"]), col = alpha("#99CC00", 0.2), border = "#99CC00")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")

remove(chull, polys)

```

```{r PC1 & PC2 loadingss}
PC_loadings <- data.frame(PCA$rotation)
barplot(PC_loadings$PC1, col = "#006600", xlab = "Measurements", ylab = "PC1 Loadings", main = "Large Macropod Astragali - PC1 loadings", names.arg = rownames(PC_loadings))
barplot(PC_loadings$PC2, col = "#006600", xlab = "Measurements", ylab = "PC2 Loadings", main = "Large Macropod Astragali - PC2 loadings", names.arg = rownames(PC_loadings))
remove(PC_loadings)
```

##Medium Macropod PCA

```{r Create groups}
Mediumspc <- LSR.Medium$Group[1:58] 
Mediumspc <- gsub("Spectacled hare-wallaby", "#33FFFF", Mediumspc)
Mediumspc <- gsub("Bridled nail-tail wallaby", "#CCCC00", Mediumspc)
Mediumspc <- gsub("Northern nail-tail wallaby", "#FFFF00", Mediumspc)
Mediumspc <- gsub("Short-eared rock-wallaby", "#FF33CC", Mediumspc)
Mediumspc <- gsub("Black-flanked rock-wallaby", "#CC0066", Mediumspc)
Mediumspc <- gsub("Rothschild's rock-wallaby", "#FFCCCC", Mediumspc)
Mediumspc2 <- LSR.Medium$Genus[59:61]
Mediumspc2 <- gsub("Boodie", "#000000", Mediumspc2)
Mediumspc <- c(Mediumspc, Mediumspc2)
remove(Mediumspc2)
Mediumspc

Mediumage <- LSR.Medium$Age
Mediumage <- (gsub("Juvenile", 18, Mediumage))
Mediumage <- (gsub("Subadult", 17, Mediumage))
Mediumage <- (gsub("Adult", 16, Mediumage))
Mediumage <- ifelse(Mediumage <16, 15, Mediumage)
Mediumage <- ifelse(Mediumage >18, 15, Mediumage)
Mediumage <- ifelse(is.na(Mediumage), 15, Mediumage)
Mediumage <- as.numeric(Mediumage)
Mediumage

Mediumgenus <- LSR.Medium$Genus
Mediumgenus <-gsub("Lagorchestes", "#33FFFF", Mediumgenus)
Mediumgenus <-gsub("Onychogalea", "#FFFF00", Mediumgenus)
Mediumgenus <-gsub("Petrogale", "#CC0066", Mediumgenus)
Mediumgenus <-gsub("Boodie", "#000000", Mediumgenus)
Mediumgenus

```

```{r #Plot PC1 vs PC2}
PCA <- prcomp(LSR.Medium[,10:16])
sum.PCA <- summary(PCA)

chull <- cbind(LSR.Medium[,1:8], PCA$x[,1:2])
polys <- ddply(chull, .(Group), function(chull) chull[chull(chull$PC1, chull$PC2), ])

plot(PCA$x[,2] ~ PCA$x[,1], 
     pch=Mediumage,
     col=Mediumspc,
     xlab=paste("PC 1 (", round(sum.PCA$importance[2]*100, 1), "%)", sep = ""), 
     ylab=paste("PC 2 (", round(sum.PCA$importance[5]*100, 1), "%)", sep = ""), 
     asp=1, 
     cex=3)

text(PCA$x[59:61,2]~PCA$x[59:61,1], labels=LSR.Medium$Specimen_ID[59:61], pos=c(1,3,2,4), cex=1.5) 

polygon(c(polys$PC1[polys$Group=="Spectacled hare-wallaby"]), c(polys$PC2[polys$Group=="Spectacled hare-wallaby"]), col = alpha("#33FFFF", 0.2), border = "#33FFFF")
polygon(c(polys$PC1[polys$Group=="Bridled nail-tail wallaby"]), c(polys$PC2[polys$Group=="Bridled nail-tail wallaby"]), col = alpha("#CCCC00", 0.2), border = "#CCCC00")
polygon(c(polys$PC1[polys$Group=="Northern nail-tail wallaby"]), c(polys$PC2[polys$Group=="Northern nail-tail wallaby"]), col = alpha("#FFFF00", 0.2), border = "#FFFF00")
polygon(c(polys$PC1[polys$Group=="Short-eared rock-wallaby"]), c(polys$PC2[polys$Group=="Short-eared rock-wallaby"]), col = alpha("#FF33CC", 0.2), border = "#FF33CC")
polygon(c(polys$PC1[polys$Group=="Black-flanked rock-wallaby"]), c(polys$PC2[polys$Group=="Black-flanked rock-wallaby"]), col = alpha("#CC0066", 0.2), border = "#CC0066")
polygon(c(polys$PC1[polys$Group=="Rothschild's rock-wallaby"]), c(polys$PC2[polys$Group=="Rothschild's rock-wallaby"]), col = alpha("#FFCCCC", 0.2), border = "#FFCCCC")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")

remove(chull, polys)
```

```{r PC1 & PC2 loadings}
PC_loadings <- data.frame(PCA$rotation)
barplot(PC_loadings$PC1, col = "#33FFFF", xlab = "Measurements", ylab = "PC1 Loadings", main = "Medium Macropod Astragali - PC1 Loadings", names.arg = rownames(PC_loadings))
barplot(PC_loadings$PC2, col = "#33FFFF", xlab = "Measurements", ylab = "PC2 Loadings", main = "Medium Macropod Astragali - PC2 Loadings", names.arg = rownames(PC_loadings))
remove(PC_loadings)
```

##Small Macropod PCA

```{r Create groups}
Smallspc <- LSR.Small$Group[1:68]
Smallspc <- gsub("Burrowing bettong", "#CCCCCC", Smallspc)
Smallspc <- gsub("Brush-tailed bettong", "#666666", Smallspc)
Smallspc <- gsub("Spectacled hare-wallaby", "#33FFFF", Smallspc)
Smallspc <- gsub("Rufous hare-wallaby", "#00FFCC", Smallspc)
Smallspc <- gsub("Banded hare-wallaby", "#339999", Smallspc)
Smallspc <- gsub("Nabarlek", "#FFCCFF", Smallspc)
Smallspc2 <- LSR.Small$Genus[69:78] 
Smallspc2 <- gsub("Boodie", "#000000", Smallspc2)
Smallspc <- c(Smallspc, Smallspc2)
remove(Smallspc2)
Smallspc

Smallage <- LSR.Small$Age
Smallage <- (gsub("Juvenile", 18, Smallage))
Smallage <- (gsub("Subadult", 17, Smallage))
Smallage <- (gsub("Adult", 16, Smallage))
Smallage <- ifelse(Smallage <16, 15, Smallage)
Smallage <- ifelse(Smallage >18, 15, Smallage)
Smallage <- ifelse(is.na(Smallage), 15, Smallage)
Smallage <- as.numeric(Smallage)
Smallage

Smallgenus <- LSR.Small$Genus
Smallgenus <-gsub("Bettongia", "#666666", Smallgenus)
Smallgenus <-gsub("Lagorchestes", "#33FFFF", Smallgenus)
Smallgenus <-gsub("Lagostrophus", "#339999", Smallgenus)
Smallgenus <-gsub("Petrogale", "#CC0066", Smallgenus)
Smallgenus <-gsub("Boodie", "#000000", Smallgenus)
Smallgenus
```

```{r #Plot PC1 vs PC2}
PCA <- prcomp(LSR.Small[,10:16])
sum.PCA <- summary(PCA)

chull <- cbind(LSR.Small[,1:8], PCA$x[,1:2])
polys <- ddply(chull, .(Group), function(chull) chull[chull(chull$PC1, chull$PC2), ])

plot(PCA$x[,2] ~ PCA$x[,1], 
     pch=Smallage,
     col=Smallspc,
     xlab=paste("PC 1 (", round(sum.PCA$importance[2]*100, 1), "%)", sep = ""), 
     ylab=paste("PC 2 (", round(sum.PCA$importance[5]*100, 1), "%)", sep = ""), 
     asp=1, 
     cex=3)

text(PCA$x[69:78,2]~PCA$x[69:78,1], labels=LSR.Small$Specimen_ID[69:78], pos=c(1,3,2,4), cex=1.5) 

polygon(c(polys$PC1[polys$Group=="Burrowing bettong"]), c(polys$PC2[polys$Group=="Burrowing bettong"]), col = alpha("#CCCCCC", 0.2), border = "#CCCCCC")
polygon(c(polys$PC1[polys$Group=="Brush-tailed bettong"]), c(polys$PC2[polys$Group=="Brush-tailed bettong"]), col = alpha("#666666", 0.2), border = "#666666")
polygon(c(polys$PC1[polys$Group=="Rufous hare-wallaby"]), c(polys$PC2[polys$Group=="Rufous hare-wallaby"]), col = alpha("#00FFCC", 0.2), border = "#00FFCC")
polygon(c(polys$PC1[polys$Group=="Banded hare-wallaby"]), c(polys$PC2[polys$Group=="Banded hare-wallaby"]), col = alpha("#339999", 0.2), border = "#339999")
polygon(c(polys$PC1[polys$Group=="Nabarlek"]), c(polys$PC2[polys$Group=="Nabarlek"]), col = alpha("#FFCCFF", 0.2), border = "#FFCCFF")
polygon(c(polys$PC1[polys$Group=="Spectacled hare-wallaby"]), c(polys$PC2[polys$Group=="Spectacled hare-wallaby"]), col = alpha("#33FFFF", 0.2), border = "#33FFFF")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")

remove(chull, polys)
```

```{r PC1 & PC2 loadings}
PC_loadings <- data.frame(PCA$rotation)
barplot(PC_loadings$PC1, col = "#666666", xlab = "Measurements", ylab = "PC1 Loadings", main = "Small Macropod Astragali - PC1 Loadings", names.arg = rownames(PC_loadings))
barplot(PC_loadings$PC2, col = "#666666", xlab = "Measurements", ylab = "PC2 Loadings", main = "Small Macropod Astragali - PC2 Loadings", names.arg = rownames(PC_loadings))
remove(PC_loadings)
```

##Multivariate Analysis of Variance

```{r Test for multivariate normality}
MV.norm <- Data.train[,c(1, 9:15)]
MVN = mvn(data = MV.norm, subset = "Genus", mvnTest = "mardia",
             multivariatePlot = "qq", multivariateOutlierMethod = "adj",
             showOutliers = TRUE, showNewData = TRUE)
MVN$multivariateNormality
```

```{r Test for homogeneity of variance-covariance matrix}
box_m(MV.norm[,-1], MV.norm[,1])
remove(MV.norm, MVN)
```

```{r Large Macropod MANOVAs}
tmp <- prcomp(LSR.Large[,10:16])
LargeMacrpd <- cbind(LSR.Large[,1:9], tmp$x)
summary(tmp)
remove(tmp)

LargeMacrpd$Age = str_replace_all(LargeMacrpd$Age,"Juvenile","Immature")
LargeMacrpd$Age = str_replace_all(LargeMacrpd$Age,"Subadult","Immature")
Ontogeny <- filter(LargeMacrpd, Age != "NA")
Ontogeny.LargeGenus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Ontogeny)

 #Agile Wallaby (Notamacropus agilis)
Nagilis <- filter(LargeMacrpd, Group == "Agile wallaby")

Allom.Nagilis <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ GeoMean, data = Nagilis)

Ontogeny.Nagilis <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Nagilis)

Nagilis <- filter(Nagilis, Sex != "NA")
Sex.Nagilis <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Sex, data = Nagilis)

  #Osphranter species
Osphranter <- filter(LargeMacrpd, Genus == "Osphranter")
Osphranter <- filter(Osphranter, Age != "NA")
Ontogeny.Osphranter <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Osphranter)

  #Common wallaroo
Orobustus <- filter(LargeMacrpd, Group == "Common wallaroo")
Orobustus$Island <- Orobustus$Species
Orobustus$Island = str_replace_all(Orobustus$Island,"robustus isabellinus","Island")
Orobustus$Island = str_replace_all(Orobustus$Island,"robustus robustus","Mainland")
Orobustus$Island = str_replace_all(Orobustus$Island,"robustus erubescens","Mainland")
Orobustus$Island = str_replace_all(Orobustus$Island,"robustus woodwardi","Mainland")
Orobustus$Island = str_replace_all(Orobustus$Island,"robustus","Mainland")
Shape.OrobSubsp <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Island, data = Orobustus)

Allom.Orobustus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ GeoMean, data = Orobustus)

Orobustus <- filter(Orobustus, Age != "NA")
Ontogeny.Orobustus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Orobustus)

  #Red kangaroo (Osphranter rufus)
Orufus <- filter(LargeMacrpd, Group == "Red kangaroo")

Allom.Orufus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ GeoMean, data = Orufus)

Orufus <- filter(Orufus, Age != "NA")
Ontogeny.Orufus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Orufus)

Orufus <- filter(LargeMacrpd, Group == "Red kangaroo")
Orufus <- filter(Orufus, Sex != "NA")
Sex.Orufus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Sex, data = Orufus)

  #Western grey kangaroo (Macropus fuliginosus)
Mfuliginosus <- filter(LargeMacrpd, Group == "W. grey kangaroo")

Allom.Mfuliginosus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ GeoMean, data = Mfuliginosus)

Ontogeny.Mfuliginosus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Mfuliginosus)

#Summary of MANOVAs
LargeMacropod.Manovas <- data.frame('Taxa'= character(0),'MANOVA' = character(0), 'df1' = integer(0),'df2' = integer(0), "F Stat" = integer(0), "p"= integer(0))
LargeMacropod.Manovas[1,] <- rbind(LargeMacropod.Manovas, c("All Large Macropods","Shape ~ Age", round(summary(Ontogeny.LargeGenus)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Agile wallaby","Shape ~ Size", round(summary(Allom.Nagilis)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Agile wallaby","Shape ~ Age", round(summary(Ontogeny.Nagilis)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Agile wallaby","Shape ~ Sex", round(summary(Sex.Nagilis)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Osphranter species","Shape ~ Age", round(summary(Ontogeny.Osphranter)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Common wallaroo","Shape ~ Subspecies", round(summary(Shape.OrobSubsp)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Common wallaroo","Shape ~ Size", round(summary(Allom.Orobustus)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Common wallaroo","Shape ~ Age", round(summary(Ontogeny.Orobustus)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Red kangaroo","Shape ~ Size", round(summary(Allom.Orufus)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Red kangaroo","Shape ~ Age", round(summary(Ontogeny.Orufus)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Red kangaroo","Shape ~ Sex", round(summary(Sex.Orufus)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Western grey kangaroo","Shape ~ Size", round(summary(Allom.Mfuliginosus)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Western grey kangaroo","Shape ~ Age", round(summary(Ontogeny.Mfuliginosus)$stats[1,c(4,5,3,6)],3)))

num <- as.numeric(LargeMacropod.Manovas[,3])
den <- as.numeric(LargeMacropod.Manovas[,4])
QF <- qf(0.01, num, den)
Fcritical <- LargeMacropod.Manovas[,5] > QF
LargeMacropod.Manovas <- cbind(LargeMacropod.Manovas[,1:4], Fcritical, LargeMacropod.Manovas[,5:6])
colnames(LargeMacropod.Manovas)[5] <- 'F>Fcritical at 0.01'

LargeMacropod.Manovas

remove(den, Fcritical, num, QF, Allom.Mfuliginosus, Allom.Nagilis, Allom.Orobustus, Allom.Orufus, LargeMacrpd, Mfuliginosus, Nagilis, Ontogeny, Ontogeny.LargeGenus, Ontogeny.Mfuliginosus, Ontogeny.Nagilis, Ontogeny.Orobustus, Ontogeny.Orufus, Ontogeny.Osphranter, Orobustus, Orufus, Osphranter,  Sex.Nagilis, Sex.Orufus, Shape.OrobSubsp)
```

```{r Medium Macropod MANOVAs}
tmp <- prcomp(LSR.Medium[1:58,10:16])
MediumMacrpd <- cbind(LSR.Medium[1:58,1:9], tmp$x)
summary(tmp)
remove(tmp)

MediumMacrpd$Age = str_replace_all(MediumMacrpd$Age,"Juvenile","Immature")
MediumMacrpd$Age = str_replace_all(MediumMacrpd$Age,"Subadult","Immature")
Ontogeny <- filter(MediumMacrpd, Age != "NA")
Ontogeny.MediumGenus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Ontogeny)

  #Onychogalea species
Onychogalea <- filter(MediumMacrpd, Genus == "Onychogalea")
Onychogalea <- filter(Onychogalea, Age != "NA")
Ontogeny.Onychogalea <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Onychogalea)

  #Bridled nail-tail wallaby
Ofraenata <- filter(MediumMacrpd, Group == "Bridled nail-tail wallaby")
Allom.Ofraenata <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ GeoMean, data = Ofraenata)

  #Northern nail-tail wallaby
Ounguifera <- filter(MediumMacrpd, Group == "Northern nail-tail wallaby")
Allom.Ounguifera <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ GeoMean, data = Ounguifera)

Ounguifera <- filter(Ounguifera, Age != "NA")
Ontogeny.Ounguifera <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Ounguifera)

Ounguifera <- filter(MediumMacrpd, Group == "Northern nail-tail wallaby")
Ounguifera <- filter(Ounguifera, Sex != "NA")
Sex.Ounguifera <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Sex, data = Ounguifera)

  #Petrogale species
Petrogale <- filter(MediumMacrpd, Genus == "Petrogale")
Petrogale <- filter(Petrogale, Age != "NA")
Ontogeny.Petrogale <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Petrogale)

  #Black-flanked rock-wallaby 
Plateralis <- filter(MediumMacrpd, Group == "Black-flanked rock-wallaby")
Allom.Plateralis <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ GeoMean, data = Plateralis)

Plateralis <- filter(Plateralis, Age != "NA")
Ontogeny.Plateralis <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Plateralis)

  #Spectacled hare-wallaby
Lconspicillatus <- filter(MediumMacrpd, Group == "Spectacled hare-wallaby")
Allom.Lconspicillatus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ GeoMean, data = Lconspicillatus)

Lconspicillatus <- filter(Lconspicillatus, Age != "NA")
Ontogeny.Lconspicillatus <- manova(cbind(PC1, PC2, PC3, PC4, PC5) ~ Age, data = Lconspicillatus)

#Summary of MANOVAs
MediumMacropod.Manovas <- data.frame('Taxa'= character(0),'MANOVA' = character(0), 'df1' = integer(0),'df2' = integer(0), "F Stat" = integer(0), "p"= integer(0))
MediumMacropod.Manovas[1,] <- rbind(MediumMacropod.Manovas, c("All Medium Macropods","Shape ~ Age", round(summary(Ontogeny.MediumGenus)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Onychogalea species","Shape ~ Age", round(summary(Ontogeny.Onychogalea)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Bridled nail-tail wallaby","Shape ~ Size", round(summary(Allom.Ofraenata)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Northern nail-tail wallaby","Shape ~ Size", round(summary(Allom.Ounguifera)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Northern nail-tail wallaby","Shape ~ Age", round(summary(Ontogeny.Ounguifera)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Northern nail-tail wallaby","Shape ~ Sex", round(summary(Sex.Ounguifera)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Petrogale species","Shape ~ Age", round(summary(Ontogeny.Petrogale)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Black-flanked rock-wallaby","Shape ~ Size", round(summary(Allom.Plateralis)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Black-flanked rock-wallaby","Shape ~ Age", round(summary(Ontogeny.Plateralis)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Spectacled hare-wallaby","Shape ~ Size", round(summary(Allom.Lconspicillatus)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Spectacled hare-wallaby","Shape ~ Age", round(summary(Ontogeny.Lconspicillatus)$stats[1,c(4,5,3,6)],3)))

num <- as.numeric(MediumMacropod.Manovas[,3])
den <- as.numeric(MediumMacropod.Manovas[,4])
QF <- qf(0.01, num, den)
Fcritical <- MediumMacropod.Manovas[,5] > QF
MediumMacropod.Manovas <- cbind(MediumMacropod.Manovas[,1:4], Fcritical, MediumMacropod.Manovas[,5:6])
colnames(MediumMacropod.Manovas)[5] <- 'F>Fcritical at 0.01'

MediumMacropod.Manovas

remove(Allom.Lconspicillatus, Allom.Plateralis, Allom.Ofraenata, Allom.Ounguifera, Lconspicillatus, MediumMacrpd, Ofraenata, Ontogeny, Ontogeny.Lconspicillatus, Ontogeny.MediumGenus, Ontogeny.Onychogalea, Ontogeny.Ounguifera, Ontogeny.Petrogale, Ontogeny.Plateralis, Onychogalea, Ounguifera, Petrogale, Plateralis, Sex.Ounguifera, den, num, Fcritical, QF)
```

```{r Small macropod MANOVAs}
tmp <- prcomp(LSR.Small[1:68,10:16])
SmallMacrpd <- cbind(LSR.Small[1:68,1:9], tmp$x)
summary(tmp)
remove(tmp)

SmallMacrpd$Age = str_replace_all(SmallMacrpd$Age,"Juvenile","Immature")
SmallMacrpd$Age = str_replace_all(SmallMacrpd$Age,"Subadult","Immature")
Ontogeny <- filter(SmallMacrpd, Age != "NA")
Ontogeny.SmallGenus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Ontogeny)

  #Banded hare-wallaby
Lfasciatus <- filter(SmallMacrpd, Genus == "Lagostrophus")
Allom.Lfasciatus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Lfasciatus)

Ontogeny.Lfasciatus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Lfasciatus)

  #Bettongia species
Bettongia <- filter(SmallMacrpd, Genus == "Bettongia")
Bettongia <- filter(Bettongia, Age != "NA")
Ontogeny.Bettongia <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Bettongia)

  #Brush-tailed bettong
Bpenicillata <- filter(SmallMacrpd, Group == "Brush-tailed bettong")

Allom.Bpenicillata <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Bpenicillata)

Ontogeny.Bpenicillata <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Bpenicillata)

Bpenicillata <- filter(Bpenicillata, Sex != "NA")
Sex.Bpenicillata <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Sex, data = Bpenicillata)

  #Bettongia lesueur
Blesueur <- filter(SmallMacrpd, Group == "Burrowing bettong")

Allom.Blesueur <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Blesueur)

Blesueur <- filter(Blesueur, Age != "NA")
Ontogeny.Blesueur <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Blesueur)

  #Lagorchestes species
Lagorchestes <- filter(SmallMacrpd, Genus == "Lagorchestes")

Lagorchestes <- filter(Lagorchestes, Age != "NA")
Ontogeny.Lagorchestes <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Lagorchestes)

  #Rufous hare-wallaby
Lhirsutus <- filter(SmallMacrpd, Group == "Rufous hare-wallaby")
Lhirsutus$Island <- Lhirsutus$Species
Lhirsutus$Island = str_replace_all(Lhirsutus$Island,"hirsutus bernieri","Island")
Lhirsutus$Island = str_replace_all(Lhirsutus$Island,"hirsutus dorreae","Island")
Lhirsutus$Island = str_replace_all(Lhirsutus$Island,"hirsutus","Mainland")
Shape.LhirsutsSubsp <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Island, data = Lhirsutus)

Allom.Lhirsutus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Lhirsutus)

Ontogeny.Lhirsutus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Lhirsutus)

Lhirsutus <- filter(Lhirsutus, Sex != "NA")
Sex.Lhirsutus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Sex, data = Lhirsutus)

#Summary of Small Macropod MANOVAs
SmallMacropod.Manovas <- data.frame('Taxa'= character(0),'MANOVA' = character(0), 'df1' = integer(0),'df2' = integer(0), "F Stat" = integer(0), "p"= integer(0))
SmallMacropod.Manovas[1,] <- rbind(SmallMacropod.Manovas, c("All Small Macropods","Shape ~ Age", round(summary(Ontogeny.SmallGenus)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Banded hare-wallaby","Shape ~ Size", round(summary(Allom.Lfasciatus)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Banded hare-wallaby","Shape ~ Age", round(summary(Ontogeny.Lfasciatus)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Bettongia species","Shape ~ Age", round(summary(Ontogeny.Bettongia)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Brush-tailed bettong","Shape ~ Size", round(summary(Allom.Bpenicillata)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Brush-tailed bettong","Shape ~ Age", round(summary(Ontogeny.Bpenicillata)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Brush-tailed bettong","Shape ~ Sex", round(summary(Sex.Bpenicillata)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Burrowing bettong","Shape ~ Size", round(summary(Allom.Blesueur)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Burrowing bettong","Shape ~ Age", round(summary(Ontogeny.Blesueur)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Lagorchestes species","Shape ~ Age", round(summary(Ontogeny.Lagorchestes)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Rufous hare-wallaby","Shape ~ Sub-Species", round(summary(Shape.LhirsutsSubsp)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Rufous hare-wallaby","Shape ~ Size", round(summary(Allom.Lhirsutus)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Rufous hare-wallaby","Shape ~ Age", round(summary(Ontogeny.Lhirsutus)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Rufous hare-wallaby","Shape ~ Sex", round(summary(Sex.Lhirsutus)$stats[1,c(4,5,3,6)],3)))

num <- as.numeric(SmallMacropod.Manovas[,3])
den <- as.numeric(SmallMacropod.Manovas[,4])
QF <- qf(0.01, num, den)
Fcritical <- SmallMacropod.Manovas[,5] > QF
SmallMacropod.Manovas <- cbind(SmallMacropod.Manovas[,1:4], Fcritical, SmallMacropod.Manovas[,5:6])
colnames(SmallMacropod.Manovas)[5] <- 'F>Fcritical at 0.01'

SmallMacropod.Manovas

remove(Allom.Blesueur, Allom.Bpenicillata, Allom.Lfasciatus, Allom.Lhirsutus, Bettongia, Blesueur, Bpenicillata, Lagorchestes, Lfasciatus, Lhirsutus, Ontogeny, Ontogeny.Bettongia, Ontogeny.Blesueur, Ontogeny.Bpenicillata, Ontogeny.Lagorchestes, Ontogeny.Lfasciatus, Ontogeny.Lhirsutus, Ontogeny.SmallGenus, Sex.Bpenicillata, Sex.Lhirsutus, Shape.LhirsutsSubsp, SmallMacrpd, den, num, Fcritical, QF)
```

##Large Macropods - Linear Discriminant Analysis (LDA)

```{r Cross Validated LDA on Form (size included) - by Genus}
Sub.train <- rbind(filter(Data.train, Size == "Large"), filter(Data.train, Group == "Northern nail-tail wallaby"))
lda.form.genus <- lda(Sub.train[,9:15], Sub.train$Genus, CV=T)
Hit.ratio <- length(which(lda.form.genus$class==Sub.train$Genus))/length(Sub.train$Genus)
Hit.ratio
CVtable.large <- table(Sub.train$Genus, lda.form.genus$class)
CVtable.large

#Hit ratio must be > Maximum Chance Criterion +25% (Ramayah et al. 2014)
tmp <- lda(Sub.train[,9:15], Sub.train$Genus, CV=F)
Cmax <- as.numeric(sort(tmp$counts, decreasing = TRUE))
Cmax <- (Cmax[1]/tmp$N)*1.25

#Hit ratio must be > Proportional Chance Criterion + 25% (Sanchez 1974; Kovarovic et al. 2011; Ramayah et al. 2014)
Cpro <- (sum(tmp$prior^2))*1.25

#Press Q statistic (Ramayah et al. 2014)
PressQ <- ((tmp$N - ((tmp$N*Hit.ratio)*(length(tmp$lev))))^2)/((tmp$N)*((length(tmp$lev)-1)))
PressQ >= qchisq(0.01, (length(tmp$lev)-1))

CV.genus.form <- data.frame('Element' = character(0), 'Size' = character(0), 'Hit Ratio' = integer(0), 'Cmax+25' = integer(0), 'Cpro+25' = integer(0), 'Press.Q'= integer(0))
CV.genus.form[1,] <- rbind(CV.genus.form, c("Astragalus", "Large", round(Hit.ratio,2), round(Cmax,2), round(Cpro,2), round(PressQ,2)))
remove(tmp, Hit.ratio, Cmax, Cpro, PressQ)
CV.genus.form
```

```{r plot LDA.form by Genus }
lda.form.genus <- lda(Sub.train[,9:15], Sub.train$Genus, CV=F)
lda.form.train.predict <- predict(lda.form.genus)
lda.form.plot <- cbind(Sub.train[,1:8], lda.form.train.predict$x) 

chull <- lda.form.plot
polys <- ddply(chull, .(Genus), function(chull) chull[chull(chull$LD1, chull$LD2), ])

plot(lda.form.plot$LD2 ~ lda.form.plot$LD1,
     pch=Largeage,
     col=Largespc,
     xlab=("LD1 50.78%"),
     ylab=("LD2 44.36%"),
     asp = 1,
     cex=3)

polygon(c(polys$LD1[polys$Genus=="Onychogalea"]), c(polys$LD2[polys$Genus=="Onychogalea"]), col = alpha("#FFFF00", 0.2), border = "#FFFF00")
polygon(c(polys$LD1[polys$Genus=="Macropus"]), c(polys$LD2[polys$Genus=="Macropus"]), col = alpha("#FF6633", 0.2), border = "#FF6633")
polygon(c(polys$LD1[polys$Genus=="Notamacropus"]), c(polys$LD2[polys$Genus=="Notamacropus"]), col = alpha("#0000FF", 0.2), border = "#0000FF")
polygon(c(polys$LD1[polys$Genus=="Osphranter"]), c(polys$LD2[polys$Genus=="Osphranter"]), col = alpha("#00FF00", 0.2), border = "#00FF00")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")
```

```{r LD1 & LD2 loadings LDA.form.genus}
LD_loadings <- data.frame(lda.form.genus$scaling)
barplot(LD_loadings$LD1, col = "#006600", xlab = "Measurements", ylab = "LD1 Loadings (50.78% variance)", main = "Large Macropod Astragali - LD1 Loadings", names.arg = rownames(LD_loadings))
barplot(LD_loadings$LD2, col = "#006600", xlab = "Measurements", ylab = "LD2 Loadings (44.36% variance)", main = "Large Macropod Astragali - LD2 Loadings", names.arg = rownames(LD_loadings))
remove(chull, LD_loadings, lda.form.genus, lda.form.plot, lda.form.train.predict, polys, Sub.train)
```      

##Medium Macropods - Linear Discriminant Analysis (LDA)
```{r Cross Validated LDA on Form (size included) - by Genus}
Sub.train <- filter(Data.train, Size == "Medium")

lda.form.genus <- lda(Sub.train[,9:15], Sub.train$Genus, CV=T)
Hit.ratio <- length(which(lda.form.genus$class==Sub.train$Genus))/length(Sub.train$Genus)
Hit.ratio
CVtable.medium <- table(Sub.train$Genus, lda.form.genus$class)
CVtable.medium

#Hit ratio must be > Maximum Chance Criterion +25% (Ramayah et al. 2014)
tmp <- lda(Sub.train[,9:15], Sub.train$Genus, CV=F)
Cmax <- as.numeric(sort(tmp$counts, decreasing = TRUE))
Cmax <- (Cmax[1]/tmp$N)*1.25

#Hit ratio must be > Proportional Chance Criterion + 25% (Sanchez 1974; Kovarovic et al. 2011; Ramayah et al. 2014)
Cpro <- (sum(tmp$prior^2))*1.25

#Press Q statistic (Ramayah et al. 2014)
PressQ <- ((tmp$N - ((tmp$N*Hit.ratio)*(length(tmp$lev))))^2)/((tmp$N)*((length(tmp$lev)-1)))
PressQ >= qchisq(0.01, (length(tmp$lev)-1))

CV.genus.form <- rbind(CV.genus.form, c("Astragalus", "Medium", round(Hit.ratio,2), round(Cmax,2), round(Cpro,2), round(PressQ,2)))
CV.genus.form
remove(tmp, Hit.ratio, Cmax, Cpro, PressQ)
```

```{r Predict medium archaeological specimens genus membership}
Arch <- Data.arch[c(4, 5, 13),]
lda.form.genus <-lda(Sub.train[,9:15], Sub.train$Genus, CV=F) 
lda.form.train.predict <- predict(lda.form.genus)
lda.form.arch.predict <- predict(lda.form.genus, Arch[,c(9:15)])
Medium.arch.predict <- lda.form.arch.predict$posterior
Medium.arch.predict
```

```{r plot LDA.form on Genus and compare archaeological specimens}
lda.form.plot <- cbind(Sub.train[,1:8], lda.form.train.predict$x) 
tmp <- cbind(Arch[,1:8], lda.form.arch.predict$x)
lda.form.plot <- rbind(lda.form.plot, tmp)
remove(tmp)

chull <- lda.form.plot[1:58,]
polys <- ddply(chull, .(Genus), function(chull) chull[chull(chull$LD1, chull$LD2), ])

plot(lda.form.plot$LD2 ~ lda.form.plot$LD1,
     pch=Mediumage,
     col=Mediumspc,
     xlab=("LD1 84.13%"),
     ylab=("LD2 15.87%"),
     asp = 1,
     cex=3)

text(lda.form.plot$LD2[59:61]~lda.form.plot$LD1[59:61], labels=lda.form.plot$Specimen_ID[59:61], pos=c(1,3,2,4), cex=1.5)

polygon(c(polys$LD1[polys$Genus=="Lagorchestes"]), c(polys$LD2[polys$Genus=="Lagorchestes"]), col = alpha("#33FFFF", 0.2), border = "#33FFFF")
polygon(c(polys$LD1[polys$Genus=="Onychogalea"]), c(polys$LD2[polys$Genus=="Onychogalea"]), col = alpha("#FFFF00", 0.2), border = "#FFFF00")
polygon(c(polys$LD1[polys$Genus=="Petrogale"]), c(polys$LD2[polys$Genus=="Petrogale"]), col = alpha("#CC0066", 0.2), border = "#CC0066")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")
```

```{r LD1 & LD2 loadings LDA.form.genus}
LD_loadings <- data.frame(lda.form.genus$scaling)
barplot(LD_loadings$LD1, col = "#33FFFF", xlab = "Measurements", ylab = "LD1 Loadings (84.13% variance)", main = "Medium Macropod Astragali - LD1 Loadings", names.arg = rownames(LD_loadings))
barplot(LD_loadings$LD2, col = "#33FFFF", xlab = "Measurements", ylab = "LD2 Loadings (15.87% variance)", main = "Medium Macropod Astragali - LD2 Loadings", names.arg = rownames(LD_loadings))

remove(Arch, chull, LD_loadings, lda.form.genus, lda.form.plot, lda.form.train.predict, polys, Sub.train)
```      

##Small Macropods - Linear Discriminant Analysis (LDA)

```{r Cross Validated LDA on Form (size included) - by Genus}
Sub.train <- rbind(filter(Data.train, Size == "Small"), filter(Data.train, Group == "Spectacled hare-wallaby"))
lda.form.genus <- lda(Sub.train[,9:15], Sub.train$Genus, CV=T)
Hit.ratio <- length(which(lda.form.genus$class==Sub.train$Genus))/length(Sub.train$Genus)
Hit.ratio
CVtable.small <- table(Sub.train$Genus, lda.form.genus$class)
CVtable.small

#Hit ratio must be > Maximum Chance Criterion +25% (Ramayah et al. 2014)
tmp <- lda(Sub.train[,9:15], Sub.train$Genus, CV=F)
Cmax <- as.numeric(sort(tmp$counts, decreasing = TRUE))
Cmax <- (Cmax[1]/tmp$N)*1.25

#Hit ratio must be > Proportional Chance Criterion + 25% (Sanchez 1974; Kovarovic et al. 2011; Ramayah et al. 2014)
Cpro <- (sum(tmp$prior^2))*1.25

#Press Q statistic (Ramayah et al. 2014)
PressQ <- ((tmp$N - ((tmp$N*Hit.ratio)*(length(tmp$lev))))^2)/((tmp$N)*((length(tmp$lev)-1)))
PressQ >= qchisq(0.01, (length(tmp$lev)-1))

CV.genus.form <- rbind(CV.genus.form, c("Astragalus", "Small", round(Hit.ratio,2), round(Cmax,2), round(Cpro,2), round(PressQ, 2)))
CV.genus.form
remove(tmp, Hit.ratio, Cmax, Cpro, PressQ)
```

```{r Predict small archaeological specimen genus membership}
Arch <- Data.arch[-c(4, 5, 13),] 
lda.form.genus<-lda(Sub.train[,9:15], Sub.train$Genus, CV=F) 
lda.form.train.predict <- predict(lda.form.genus)
lda.form.arch.predict <- predict(lda.form.genus, Arch[,c(9:15)])
Small.arch.predict <- lda.form.arch.predict$posterior
Small.arch.predict
```

```{r plot LDA.form on Genus and compare archaeological specimens}
lda.form.plot <- cbind(Sub.train[,1:8], lda.form.train.predict$x) 
tmp <- cbind(Arch[,1:8], lda.form.arch.predict$x)
lda.form.plot <- rbind(lda.form.plot, tmp)
remove(tmp)

chull <- lda.form.plot[1:68,] 
polys <- ddply(chull, .(Genus), function(chull) chull[chull(chull$LD1, chull$LD2), ])

plot(lda.form.plot$LD2 ~ lda.form.plot$LD1,
     pch=Smallage,
     col=Smallspc,
     xlab=("LD1 88.87%"),
     ylab=("LD2 6.29%"),
     asp = 1,
     cex=3)

text(lda.form.plot$LD2[69:78]~lda.form.plot$LD1[69:78], labels=lda.form.plot$Specimen_ID[69:78], pos=c(1,3,2,4), cex=1.5) 

polygon(c(polys$LD1[polys$Genus=="Bettongia"]), c(polys$LD2[polys$Genus=="Bettongia"]), col = alpha("#666666", 0.2), border = "#666666")
polygon(c(polys$LD1[polys$Genus=="Lagostrophus"]), c(polys$LD2[polys$Genus=="Lagostrophus"]), col = alpha("#339999", 0.2), border = "#339999")
polygon(c(polys$LD1[polys$Genus=="Lagorchestes"]), c(polys$LD2[polys$Genus=="Lagorchestes"]), col = alpha("#33FFFF", 0.2), border = "#33FFFF")
polygon(c(polys$LD1[polys$Genus=="Petrogale"]), c(polys$LD2[polys$Genus=="Petrogale"]), col = alpha("#CC0066", 0.2), border = "#CC0066")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")
```

```{r LD1 & LD2 loadings LDA.form.genus}
LD_loadings <- data.frame(lda.form.genus$scaling)
barplot(LD_loadings$LD1, col = "#666666", xlab = "Measurements", ylab = "LD1 Loadings (88.87% variance)", main = "Small Macropod Astragali - LD1 Loadings", names.arg = rownames(LD_loadings))
barplot(LD_loadings$LD2, col = "#666666", xlab = "Measurements", ylab = "LD2 Loadings (6.29% variance)", main = "Small Macropod Astragali - LD2 Loadings", names.arg = rownames(LD_loadings))

remove(Arch, chull, LD_loadings, lda.form.genus, lda.form.plot, lda.form.train.predict, polys, Sub.train)
```      

##Export all tables

```{r Table 1A Cross validated hit ratios for each skeletal element by genus and species}
write.csv(CV.genus.form, "Supp_Tables/Table.1A.csv")
```

```{r Table 2 Classification matrix for specimens from Boodie Cave}
write.csv(Medium.arch.predict, "Supp_Tables/Table.2A.csv")
write.csv(Small.arch.predict, "Supp_Tables/Table.2B.csv")
```

```{r Table S7-S9 Multivariate analysis of variance on macropod astragalus shape}
write.csv(LargeMacropod.Manovas, "Supp_Tables/Table.S7A.csv")
write.csv(MediumMacropod.Manovas, "Supp_Tables/Table.S8A.csv")
write.csv(SmallMacropod.Manovas, "Supp_Tables/Table.S9A.csv")
```
