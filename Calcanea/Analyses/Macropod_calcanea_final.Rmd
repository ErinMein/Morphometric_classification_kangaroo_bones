---
title: "Macropod_calcanea_clean"
author: "Erin Mein"
date: "10/03/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---
#Description of analyses
#This analysis includes multivariate ordinal and statistical analyses of macropod calcanea and models the classification of archaeological specimens.

```{r set library and wd}
library(MASS)
library(tidyverse)
library(car)
library(plyr)
library(Hmisc)
library(vegan)
library(rstatix)
library(MVN)

setwd("~/Dropbox/Documents/PhD/Metric_Morphometrics/Metric_morph_R/Morphometric_classification_kangaroo_bones/Calcanea")
```

```{r Import Training data}
Data.train <- read.csv(file="Data/Data.train.final.csv", header=TRUE)
rownames(Data.train) <- c(paste(substr(Data.train$Genus,1,1),substr(Data.train$Species,1,3), Data.train$Specimen_ID ,sep = "_"))
```

```{r Test for Redundancy}
redun(~Data.train[, 8] + Data.train[, 9] + Data.train[, 10] + Data.train[, 11] + Data.train[, 12] + 
    Data.train[, 13] + Data.train[, 14] + Data.train[, 15] + Data.train[, 
    16] + Data.train[, 17] + Data.train[, 18] + Data.train[, 19] + Data.train[, 
    20]+ Data.train[, 21]+ Data.train[, 22]+ Data.train[, 23]+ Data.train[, 24]+ Data.train[, 25] + Data.train[, 26] + Data.train[, 27] + Data.train[, 28] + Data.train[, 29] + Data.train[, 30] + Data.train[, 31] + Data.train[, 32] + Data.train[, 33], r2 = 0.01)

PCA <- prcomp(Data.train[,10:33])
PCAredun <- prcomp(Data.train[,c(8, 9, 21, 22, 23, 25, 26, 28, 29)])

PCA_distance <- dist(PCA$x)
PCAredun_dist <- dist(PCAredun$x)

mantel(PCA_distance, PCAredun_dist, method = "pearson", permutations = 9999)

remove(PCA, PCAredun, PCA_distance, PCAredun_dist)
```

```{r Remove redundant variables from training data}
Data.train <- Data.train[,c(1:7, 8, 9, 21, 22, 23, 25, 26, 28, 29)]
colnames(Data.train)
```

```{r calculate Geometric Mean & standardise data using Log Shape Ratio method (Claude 2013)}
GeoMean <- apply(Data.train[,8:16], 1, prod)^(1/9)
LSR.train <- log(Data.train[,8:16]/ GeoMean)
LSR.train <- cbind(Data.train[,1:7], GeoMean, LSR.train)
remove(GeoMean)
```

```{r Apply Size Categories to Training Data}
Size <- Data.train$Group
Size <- gsub("Burrowing bettong", "Small", Size)
Size <- gsub("Brush-tailed bettong", "Small", Size)
Size <- gsub("Spectacled hare-wallaby", "Medium", Size)
Size <- gsub("Rufous hare-wallaby", "Small", Size)
Size <- gsub("Banded hare-wallaby", "Small", Size)
Size <- gsub("W. grey kangaroo", "Large", Size)
Size <- gsub("Agile wallaby", "Large", Size)
Size <- gsub("Bridled nail-tail wallaby", "Medium", Size)
Size <- gsub("Northern nail-tail wallaby", "Medium", Size)
Size <- gsub("Black wallaroo", "Large", Size)
Size <- gsub("Antilopine wallaroo", "Large", Size)
Size <- gsub("Common wallaroo", "Large", Size)
Size <- gsub("Red kangaroo", "Large", Size)
Size <- gsub("Short-eared rock-wallaby", "Medium", Size)
Size <- gsub("Nabarlek", "Small", Size)
Size <- gsub("Black-flanked rock-wallaby", "Medium", Size)
Size <- gsub("Rothschild's rock-wallaby", "Medium", Size)

Data.train <- cbind(Data.train[,1:6], Size, Data.train[7:16])
LSR.train <- cbind(LSR.train[,1:6], Size, LSR.train[,7:17])
remove(Size)
```

```{r Import Archaeological Data}
Data.arch <- read.csv(file="Data/Data.arch.csv", header=TRUE)
colnames(Data.arch)[5:6] <- c("Sex", "Age")
rownames(Data.arch) <- c(paste(substr(Data.arch$Genus,1,1),substr(Data.arch$Species,1,3), Data.arch$Specimen_ID ,sep = "_"))
```

```{r Calculate Size of Archaeological Specimens}
GeoMean <- apply(Data.arch[,9:17], 1, prod)^(1/9)
LSR.arch <- log(Data.arch[,9:17]/ GeoMean)
LSR.arch <- cbind(Data.arch[,1:8], GeoMean, LSR.arch)

colnames(LSR.arch) == colnames(LSR.train)
remove(GeoMean)

LSR.all <- rbind(LSR.train, LSR.arch)
```

```{r Plot size of arch and training specimens}
tmp <- LSR.train[,c(7,8,9)]
new_order <- with(tmp, reorder(Group , GeoMean, median , na.rm=T))
tmparch <- LSR.arch[,c(3, 9)]

boxplot(tmp$GeoMean ~ new_order,las = 2, ylab = '', xlab = "", col = 'white')
abline(a=tmparch$GeoMean[1], b= 0, col=alpha("black",0.2), lwd = 1) #"41"
abline(a=tmparch$GeoMean[2], b= 0, col=alpha("black",0.2), lwd = 1) #46
abline(a=tmparch$GeoMean[3], b= 0, col=alpha("black",0.2), lwd = 1) #47
abline(a=tmparch$GeoMean[4], b= 0, col=alpha("black",0.2), lwd = 1) #59
abline(a=tmparch$GeoMean[5], b= 0, col=alpha("black",0.2), lwd = 1) #85
abline(a=tmparch$GeoMean[6], b= 0, col=alpha("black",0.2), lwd = 1) #261
abline(a=tmparch$GeoMean[7], b= 0, col=alpha("black",0.2), lwd = 1) #331

remove(tmp, tmparch, new_order)
```

```{r Split Training Data & Archaeological Data into Size Classes}
LSR.Large <- rbind(filter(LSR.all, Size == "Large"), filter(LSR.all, Group == "Northern nail-tail wallaby"))

tmp <- filter(LSR.arch, GeoMean > 4)
LSR.Medium <- rbind(filter(LSR.all, Size == "Medium"), tmp)

tmp <- filter(LSR.arch, GeoMean < 4)
LSR.Small <- rbind(filter(LSR.all, Size == "Small"), tmp)

remove(tmp, LSR.all, LSR.arch)
```

##Large Macropod PCA

```{r Create groups}
largespc <- LSR.Large$Group 
largespc <- gsub("W. grey kangaroo", "#FF6633", largespc)
largespc <- gsub("Agile wallaby", "#0000FF", largespc)
largespc <- gsub("Northern nail-tail wallaby", "#FFFF00", largespc)
largespc <- gsub("Black wallaroo", "#99CC00", largespc)
largespc <- gsub("Antilopine wallaroo", "#009966", largespc)
largespc <- gsub("Common wallaroo", "#00FF00", largespc)
largespc <- gsub("Red kangaroo", "#006600", largespc)
largespc

largeage <- LSR.Large$Age
largeage <- (gsub("Juvenile", 18, largeage))
largeage <- (gsub("Subadult", 17, largeage))
largeage <- (gsub("Adult", 16, largeage))
largeage <- ifelse(largeage <16, 15, largeage)
largeage <- ifelse(largeage >18, 15, largeage)
largeage <- ifelse(is.na(largeage), 15, largeage)
largeage <- as.numeric(largeage)
largeage
```

```{r #Plot PC1 vs PC2}
PCA <- prcomp(LSR.Large[,10:18])
sum.PCA <- summary(PCA)

chull <- cbind(LSR.Large[,1:8], PCA$x[,1:2])
polys <- ddply(chull, .(Group), function(chull) chull[chull(chull$PC1, chull$PC2), ])

plot(PCA$x[,2] ~ PCA$x[,1], 
     pch=largeage,
     col=largespc,
     xlab=paste("PC 1 (", round(sum.PCA$importance[2]*100, 1), "%)", sep = ""), 
     ylab=paste("PC 2 (", round(sum.PCA$importance[5]*100, 1), "%)", sep = ""), 
     asp=1, 
     cex=3)

polygon(c(polys$PC1[polys$Group=="Northern nail-tail wallaby"]), c(polys$PC2[polys$Group=="Northern nail-tail wallaby"]), col = alpha("#FFFF00", 0.2), border = "#FFFF00")
polygon(c(polys$PC1[polys$Group=="W. grey kangaroo"]), c(polys$PC2[polys$Group=="W. grey kangaroo"]), col = alpha("#FF6633", 0.2), border = "#FF6633")
polygon(c(polys$PC1[polys$Group=="Agile wallaby"]), c(polys$PC2[polys$Group=="Agile wallaby"]), col = alpha("#0000FF", 0.2), border = "#0000FF")
polygon(c(polys$PC1[polys$Group=="Antilopine wallaroo"]), c(polys$PC2[polys$Group=="Antilopine wallaroo"]), col = alpha("#009966", 0.2), border = "#009966")
polygon(c(polys$PC1[polys$Group=="Common wallaroo"]), c(polys$PC2[polys$Group=="Common wallaroo"]), col = alpha("#00FF00", 0.2), border = "#00FF00")
polygon(c(polys$PC1[polys$Group=="Red kangaroo"]), c(polys$PC2[polys$Group=="Red kangaroo"]), col = alpha("#006600", 0.2), border = "#006600")
polygon(c(polys$PC1[polys$Group=="Black wallaroo"]), c(polys$PC2[polys$Group=="Black wallaroo"]), col = alpha("#99CC00", 0.2), border = "#99CC00")


abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")

remove(chull, polys)
```

```{r PC1 & PC2 loadings}
PC_loadings <- data.frame(PCA$rotation)
barplot(PC_loadings$PC1, col = "#006600", xlab = "Measurements", ylab = "PC1 Loadings", main = "Large Macropod Calcanea - PC1 loadings", names.arg = rownames(PC_loadings))
barplot(PC_loadings$PC2, col = "#006600", xlab = "Measurements", ylab = "PC2 Loadings", main = "Large Macropod Calcanea - PC2 loadings", names.arg = rownames(PC_loadings))
remove(PC_loadings)
```

##Medium Macropod PCA

```{r Create groups}
mediumspc <- LSR.Medium$Group[1:61]
mediumspc <- gsub("Spectacled hare-wallaby", "#33FFFF", mediumspc)
mediumspc <- gsub("Bridled nail-tail wallaby", "#CCCC00", mediumspc)
mediumspc <- gsub("Northern nail-tail wallaby", "#FFFF00", mediumspc)
mediumspc <- gsub("Short-eared rock-wallaby", "#FF33CC", mediumspc)
mediumspc <- gsub("Black-flanked rock-wallaby", "#CC0066", mediumspc)
mediumspc <- gsub("Rothschild's rock-wallaby", "#FFCCCC", mediumspc)
mediumspc2 <- LSR.Medium$Genus[62:64]
mediumspc2 <- gsub("Boodie", "#000000", mediumspc2)
mediumspc <- c(mediumspc, mediumspc2)
remove(mediumspc2)
mediumspc

mediumage <- LSR.Medium$Age
mediumage <- (gsub("Juvenile", 18, mediumage))
mediumage <- (gsub("Subadult", 17, mediumage))
mediumage <- (gsub("Adult", 16, mediumage))
mediumage <- ifelse(mediumage <16, 15, mediumage)
mediumage <- ifelse(mediumage >18, 15, mediumage)
mediumage <- ifelse(is.na(mediumage), 15, mediumage)
mediumage <- as.numeric(mediumage)
mediumage
```

```{r #Plot PC1 vs PC2}
PCA <- prcomp(LSR.Medium[,10:18])
sum.PCA <- summary(PCA)

chull <- cbind(LSR.Medium[,1:8], PCA$x[,1:2])
polys <- ddply(chull, .(Group), function(chull) chull[chull(chull$PC1, chull$PC2), ])

plot(PCA$x[,2] ~ PCA$x[,1], 
     pch=mediumage,
     col=mediumspc,
     xlab=paste("PC 1 (", round(sum.PCA$importance[2]*100, 1), "%)", sep = ""), 
     ylab=paste("PC 2 (", round(sum.PCA$importance[5]*100, 1), "%)", sep = ""), 
     asp=1, 
     cex=3)

text(PCA$x[62:64,2]~PCA$x[62:64,1], labels=LSR.Medium$Specimen_ID[62:64], pos=c(1,3,2,4), cex=1.5) #Medium

polygon(c(polys$PC1[polys$Group=="Spectacled hare-wallaby"]), c(polys$PC2[polys$Group=="Spectacled hare-wallaby"]), col = alpha("#33FFFF", 0.2), border = "#33FFFF")
polygon(c(polys$PC1[polys$Group=="Bridled nail-tail wallaby"]), c(polys$PC2[polys$Group=="Bridled nail-tail wallaby"]), col = alpha("#CCCC00", 0.2), border = "#CCCC00")
polygon(c(polys$PC1[polys$Group=="Northern nail-tail wallaby"]), c(polys$PC2[polys$Group=="Northern nail-tail wallaby"]), col = alpha("#FFFF00", 0.2), border = "#FFFF00")
polygon(c(polys$PC1[polys$Group=="Short-eared rock-wallaby"]), c(polys$PC2[polys$Group=="Short-eared rock-wallaby"]), col = alpha("#FF33CC", 0.2), border = "#FF33CC")
polygon(c(polys$PC1[polys$Group=="Black-flanked rock-wallaby"]), c(polys$PC2[polys$Group=="Black-flanked rock-wallaby"]), col = alpha("#CC0066", 0.2), border = "#CC0066")
polygon(c(polys$PC1[polys$Group=="Rothschild's rock-wallaby"]), c(polys$PC2[polys$Group=="Rothschild's rock-wallaby"]), col = alpha("#FFCCCC", 0.2), border = "#FFCCCC")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")
remove(chull, polys)
```

```{r PC1 & PC2 loadings}
PC_loadings <- data.frame(PCA$rotation)
barplot(PC_loadings$PC1, col = "#33FFFF", xlab = "Measurements", ylab = "PC1 Loadings", main = "Medium Macropod Calcanea - PC1 Loadings", names.arg = rownames(PC_loadings))
barplot(PC_loadings$PC2, col = "#33FFFF", xlab = "Measurements", ylab = "PC2 Loadings", main = "Medium Macropod Calcanea - PC2 Loadings", names.arg = rownames(PC_loadings))
remove(PC_loadings)
```

##Small Macropod PCA
```{r Create groups}
smallspc <- LSR.Small$Group[1:52]
smallspc <- gsub("Burrowing bettong", "#CCCCCC", smallspc)
smallspc <- gsub("Brush-tailed bettong", "#666666", smallspc)
smallspc <- gsub("Rufous hare-wallaby", "#00FFCC", smallspc)
smallspc <- gsub("Banded hare-wallaby", "#339999", smallspc)
smallspc <- gsub("Nabarlek", "#FFCCFF", smallspc)
smallspc2 <- LSR.Small$Genus[53:56]
smallspc2 <- gsub("Boodie", "#000000", smallspc2)
smallspc <- c(smallspc, smallspc2)
remove(smallspc2)
smallspc

smallage <- LSR.Small$Age
smallage <- (gsub("Juvenile", 18, smallage))
smallage <- (gsub("Subadult", 17, smallage))
smallage <- (gsub("Adult", 16, smallage))
smallage <- ifelse(smallage <16, 15, smallage)
smallage <- ifelse(smallage >18, 15, smallage)
smallage <- ifelse(is.na(smallage), 15, smallage)
smallage <- as.numeric(smallage)
smallage
```

```{r #Plot PC1 vs PC2}
PCA <- prcomp(LSR.Small[,10:18])
sum.PCA <- summary(PCA)

chull <- cbind(LSR.Small[,1:8], PCA$x[,1:2])
polys <- ddply(chull, .(Group), function(chull) chull[chull(chull$PC1, chull$PC2), ])

plot(PCA$x[,2] ~ PCA$x[,1], 
     pch=smallage,
     col=smallspc,
     xlab=paste("PC 1 (", round(sum.PCA$importance[2]*100, 1), "%)", sep = ""), 
     ylab=paste("PC 2 (", round(sum.PCA$importance[5]*100, 1), "%)", sep = ""), 
     asp=1, 
     cex=3)

text(PCA$x[53:56,2]~PCA$x[53:56,1], labels=LSR.Small$Specimen_ID[53:56], pos=c(1,3,2,4), cex=1.5)

polygon(c(polys$PC1[polys$Group=="Burrowing bettong"]), c(polys$PC2[polys$Group=="Burrowing bettong"]), col = alpha("#CCCCCC", 0.2), border = "#CCCCCC")
polygon(c(polys$PC1[polys$Group=="Brush-tailed bettong"]), c(polys$PC2[polys$Group=="Brush-tailed bettong"]), col = alpha("#666666", 0.2), border = "#666666")
polygon(c(polys$PC1[polys$Group=="Rufous hare-wallaby"]), c(polys$PC2[polys$Group=="Rufous hare-wallaby"]), col = alpha("#00FFCC", 0.2), border = "#00FFCC")
polygon(c(polys$PC1[polys$Group=="Banded hare-wallaby"]), c(polys$PC2[polys$Group=="Banded hare-wallaby"]), col = alpha("#339999", 0.2), border = "#339999")
polygon(c(polys$PC1[polys$Group=="Nabarlek"]), c(polys$PC2[polys$Group=="Nabarlek"]), col = alpha("#FFCCFF", 0.2), border = "#FFCCFF")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")
remove(polys, chull)
```

```{r PC1 & PC2 loadings}
PC_loadings <- data.frame(PCA$rotation)
barplot(PC_loadings$PC1, col = "#666666", xlab = "Measurements", ylab = "PC1 Loadings", main = "Small Macropod Calcanea - PC1 Loadings", names.arg = rownames(PC_loadings))
barplot(PC_loadings$PC2, col = "#666666", xlab = "Measurements", ylab = "PC2 Loadings", main = "Small Macropod Calcanea - PC2 Loadings", names.arg = rownames(PC_loadings))
remove(PC_loadings)
```

##Multivariate Analysis of Variance
```{r Test for multivariate normality}
MV.norm <- Data.train[,c(9:17, 1)]
MVN = mvn(data = MV.norm[-9], subset = "Genus", mvnTest = "mardia",
             multivariatePlot = "qq", multivariateOutlierMethod = "adj",
             showOutliers = TRUE, showNewData = TRUE)
MVN$multivariateNormality
```

```{r Test for homogeneity of variance-covariance matrix}
box_m(MV.norm[,-10], MV.norm[,10])
remove(MVN, MV.norm)
```

```{r Large Macropod MANOVAs}
tmp <- prcomp(LSR.Large[,10:18])
LargeMacrpd <- cbind(LSR.Large[,1:9], tmp$x)
summary(tmp)
remove(tmp)

LargeMacrpd$Age = str_replace_all(LargeMacrpd$Age,"Juvenile","Immature")
LargeMacrpd$Age = str_replace_all(LargeMacrpd$Age,"Subadult","Immature")
Ontogeny <- filter(LargeMacrpd, Age != "NA")
Ontogeny.LargeGenus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Ontogeny)

  #Agile wallaby
Nagilis <- filter(LargeMacrpd, Group == "Agile wallaby")

Allom.Nagilis <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Nagilis)

Nagilis$Age = str_replace_all(Nagilis$Age,"Juvenile","Immature")
Nagilis$Age = str_replace_all(Nagilis$Age,"Subadult","Immature")
Nagilis <- filter(Nagilis, Age != "NA")
Ontogeny.Nagilis <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Nagilis)

  #Osphranter species 
Osphranter <- filter(LargeMacrpd, Genus == "Osphranter")

Osphranter$Age = str_replace_all(Osphranter$Age,"Juvenile","Immature")
Osphranter$Age = str_replace_all(Osphranter$Age,"Subadult","Immature")
Osphranter <- filter(Osphranter, Age != "NA")
Ontogeny.Osphranter <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Osphranter)

  #Common wallaroo
Orobustus <- filter(LargeMacrpd, Group == "Common wallaroo")
Orobustus$Island = str_replace_all(Orobustus$Species,"robustus robustus","Mainland")
Orobustus$Island = str_replace_all(Orobustus$Species,"robustus","Mainland")
Orobustus$Island = str_replace_all(Orobustus$Species,"robustus erubescens","Mainland")
Orobustus$Island = str_replace_all(Orobustus$Species,"robustus woodwardi","Mainland")
Orobustus$Island = str_replace_all(Orobustus$Species,"robustus isabellinus","Island")
Shape.OrobSubsp <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Island, data = Orobustus)

Allom.Orobustus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Orobustus)

Orobustus <- filter(Osphranter, Group == "Common wallaroo")
Ontogeny.Orobustus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Orobustus)

  #Osphranter rufus
Orufus <- filter(LargeMacrpd, Group == "Red kangaroo")

Allom.Orufus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Orufus)

Orufus$Age = str_replace_all(Orufus$Age,"Juvenile","Immature")
Orufus$Age = str_replace_all(Orufus$Age,"Subadult","Immature")
Orufus <- filter(Orufus, Age != "NA")
Ontogeny.Orufus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Orufus)

  #Western grey kangaroo
Mfuliginosus <- filter(LargeMacrpd, Group == "W. grey kangaroo")

Allom.Mfuliginosus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Mfuliginosus)

Mfuliginosus$Age = str_replace_all(Mfuliginosus$Age,"Juvenile","Immature")
Mfuliginosus$Age = str_replace_all(Mfuliginosus$Age,"Subadult","Immature")
Mfuliginosus <- filter(Mfuliginosus, Age != "NA")
Ontogeny.Mfuliginosus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Mfuliginosus)

#Summary of MANOVAs
LargeMacropod.Manovas <- data.frame('Taxa'= character(0),'MANOVA' = character(0), 'df1' = integer(0),'df2' = integer(0), "F Stat" = integer(0), "p"= integer(0))
LargeMacropod.Manovas[1,] <- rbind(LargeMacropod.Manovas, c("All Large Macropods","Shape ~ Age", round(summary(Ontogeny.LargeGenus)$stats[1,c(4,5,3,6)],3)))

LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Agile wallaby","Shape ~ Size", round(summary(Allom.Nagilis)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Agile wallaby","Shape ~ Age", round(summary(Ontogeny.Nagilis)$stats[1,c(4,5,3,6)],3)))

LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Osphranter species","Shape ~ Age", round(summary(Ontogeny.Osphranter)$stats[1,c(4,5,3,6)],3)))

LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Common wallaroo","Shape ~ Subspecies", round(summary(Shape.OrobSubsp)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Common wallaroo","Shape ~ Size", round(summary(Allom.Orobustus)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Common wallaroo","Shape ~ Age", round(summary(Ontogeny.Orobustus)$stats[1,c(4,5,3,6)],3)))

LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Red kangaroo","Shape ~ Size", round(summary(Allom.Orufus)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Red kangaroo","Shape ~ Age", round(summary(Ontogeny.Orufus)$stats[1,c(4,5,3,6)],3)))

LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Western grey kangaroo","Shape ~ Size", round(summary(Allom.Mfuliginosus)$stats[1,c(4,5,3,6)],3)))
LargeMacropod.Manovas <- rbind(LargeMacropod.Manovas, c("Western grey kangaroo","Shape ~ Age", round(summary(Ontogeny.Mfuliginosus)$stats[1,c(4,5,3,6)],3)))

num <- as.numeric(LargeMacropod.Manovas[,3])
den <- as.numeric(LargeMacropod.Manovas[,4])
QF <- qf(0.01, num, den)
Fcritical <- LargeMacropod.Manovas[,5] > QF
LargeMacropod.Manovas <- cbind(LargeMacropod.Manovas[,1:4], Fcritical, LargeMacropod.Manovas[,5:6])
colnames(LargeMacropod.Manovas)[5] <- 'F>Fcritical at 0.01'

LargeMacropod.Manovas

remove(Allom.Mfuliginosus, Allom.Nagilis, Allom.Orobustus, Allom.Orufus, LargeMacrpd, Mfuliginosus, Nagilis, Ontogeny, Ontogeny.LargeGenus, Ontogeny.Mfuliginosus, Ontogeny.Orobustus, Ontogeny.Nagilis, Ontogeny.Orufus, Ontogeny.Osphranter, Orobustus, Orufus, Osphranter, Shape.OrobSubsp, den, Fcritical, num, QF)
```

```{r Medium Macropod MANOVAs}
tmp <- prcomp(LSR.Medium[1:61,10:18])
MediumMacrpd <- cbind(LSR.Medium[1:61,1:9], tmp$x)
summary(tmp)
remove(tmp)

MediumMacrpd$Age = str_replace_all(MediumMacrpd$Age,"Juvenile","Immature")
MediumMacrpd$Age = str_replace_all(MediumMacrpd$Age,"Subadult","Immature")
Ontogeny <- filter(MediumMacrpd, Age != "NA")
Ontogeny.MediumGenus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Ontogeny)

  #Petrogale species
Petrogale <- filter(MediumMacrpd, Genus == "Petrogale")
Petrogale <- filter(Petrogale, Size != "Small")

Petrogale$Age = str_replace_all(Petrogale$Age,"Juvenile","Immature")
Petrogale$Age = str_replace_all(Petrogale$Age,"Subadult","Immature")
Petrogale <- filter(Petrogale, Age != "NA")
Ontogeny.Petrogale <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Petrogale)

  #Black-flanked rock-wallaby
Plateralis <- filter(MediumMacrpd, Group == "Black-flanked rock-wallaby")
Allom.Plateralis <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Plateralis)

Plateralis <- filter(Petrogale, Group == "Black-flanked rock-wallaby")
Ontogeny.Plateralis <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Plateralis)

  #Onychogalea species
Onychogalea <- filter(MediumMacrpd, Genus == "Onychogalea")

Onychogalea$Age = str_replace_all(Onychogalea$Age,"Juvenile","Immature")
Onychogalea$Age = str_replace_all(Onychogalea$Age,"Subadult","Immature")
Onychogalea <- filter(Onychogalea, Age != "NA")
Ontogeny.Onychogalea <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Onychogalea)

  #Bridled nail-tail wallaby
Ofraenata <- filter(MediumMacrpd, Group == "Bridled nail-tail wallaby")
Allom.Ofraenata <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Ofraenata)

  #Northern nail-tail wallaby
Ounguifera <- filter(MediumMacrpd, Group == "Northern nail-tail wallaby")
Allom.Ounguifera <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Ounguifera)

Ounguifera$Age = str_replace_all(Ounguifera$Age,"Juvenile","Immature")
Ounguifera$Age = str_replace_all(Ounguifera$Age,"Subadult","Immature")
Ounguifera <- filter(Ounguifera, Age != "NA")
Ontogeny.Ounguifera <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Ounguifera)

  #Spectacled hare-wallaby
Lconspicillatus <- filter(MediumMacrpd, Group == "Spectacled hare-wallaby")
Allom.Lconspicillatus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Lconspicillatus)

#Summary of MANOVAs
MediumMacropod.Manovas <- data.frame('Taxa'= character(0),'MANOVA' = character(0), 'df1' = integer(0),'df2' = integer(0), "F Stat" = integer(0), "p"= integer(0))
MediumMacropod.Manovas[1,] <- rbind(MediumMacropod.Manovas, c("All Medium Macropods","Shape ~ Age", round(summary(Ontogeny.MediumGenus)$stats[1,c(4,5,3,6)],3)))

MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Onychogalea species","Shape ~ Age", round(summary(Ontogeny.Onychogalea)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Bridled nail-tail wallaby","Shape ~ Size", round(summary(Allom.Ofraenata)$stats[1,c(4,5,3,6)],3)))

MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Northern nail-tail wallaby","Shape ~ Size", round(summary(Allom.Ounguifera)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Northern nail-tail wallaby","Shape ~ Age", round(summary(Ontogeny.Ounguifera)$stats[1,c(4,5,3,6)],3)))

MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Petrogale species","Shape ~ Age", round(summary(Ontogeny.Petrogale)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Black-flanked rock-wallaby","Shape ~ Size", round(summary(Allom.Plateralis)$stats[1,c(4,5,3,6)],3)))
MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Black-flanked rock-wallaby","Shape ~ Age", round(summary(Ontogeny.Plateralis)$stats[1,c(4,5,3,6)],3)))

MediumMacropod.Manovas <- rbind(MediumMacropod.Manovas, c("Spectacled hare-wallaby","Shape ~ Size", round(summary(Allom.Lconspicillatus)$stats[1,c(4,5,3,6)],3)))
num <- as.numeric(MediumMacropod.Manovas[,3])
den <- as.numeric(MediumMacropod.Manovas[,4])
QF <- qf(0.01, num, den)
Fcritical <- MediumMacropod.Manovas[,5] > QF
MediumMacropod.Manovas <- cbind(MediumMacropod.Manovas[,1:4], Fcritical, MediumMacropod.Manovas[,5:6])
colnames(MediumMacropod.Manovas)[5] <- 'F>Fcritical at 0.01'

MediumMacropod.Manovas

remove(Allom.Lconspicillatus, Allom.Ofraenata, Allom.Ounguifera, Allom.Plateralis, Lconspicillatus, MediumMacrpd, Ofraenata, Ontogeny, Ontogeny.MediumGenus, Ontogeny.Onychogalea, Ontogeny.Ounguifera, Ontogeny.Petrogale, Ontogeny.Plateralis, Onychogalea, Ounguifera, Petrogale, Plateralis, den, Fcritical, num, QF)

```

```{r Small macropod MANOVAs}
tmp <- prcomp(LSR.Small[1:52,10:18])
SmallMacrpd <- cbind(LSR.Small[1:52,1:9], tmp$x)
summary(tmp)
remove(tmp)

SmallMacrpd$Age = str_replace_all(SmallMacrpd$Age,"Juvenile","Immature")
SmallMacrpd$Age = str_replace_all(SmallMacrpd$Age,"Subadult","Immature")
Ontogeny <- filter(SmallMacrpd, Age != "NA")
Ontogeny.SmallGenus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Ontogeny)

  #Banded hare-wallaby
Lfasciatus <- filter(SmallMacrpd, Group == "Banded hare-wallaby")
Allom.Lfasciatus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Lfasciatus)

  #Bettongia species
Bettongia <- filter(SmallMacrpd, Genus == "Bettongia")
Bettongia$Age = str_replace_all(Bettongia$Age,"Juvenile","Immature")
Bettongia$Age = str_replace_all(Bettongia$Age,"Subadult","Immature")
Bettongia <- filter(Bettongia, Age != "NA")
Ontogeny.Bettongia <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Bettongia)

  #Brush-tailed bettong
Bpenicillata <- filter(SmallMacrpd, Group == "Brush-tailed bettong")

Allom.Bpenicillata <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Bpenicillata)

Bpenicillata$Age = str_replace_all(Bpenicillata$Age,"Juvenile","Immature")
Bpenicillata$Age = str_replace_all(Bpenicillata$Age,"Subadult","Immature")
Bpenicillata <- filter(Bpenicillata, Age != "NA")
Ontogeny.Bpenicillata <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Bpenicillata)

Bpenicillata <- filter(SmallMacrpd, Group == "Brush-tailed bettong")
Bpenicillata <- filter(Bpenicillata, Sex != "NA")
Sex.Bpenicillata <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Sex, data = Bpenicillata)

  #Rufous hare-wallaby
Lhirsutus <- filter(SmallMacrpd, Group == "Rufous hare-wallaby")
Lhirsutus$Island = str_replace_all(Lhirsutus$Species,"hirsutus","Mainland")
Lhirsutus$Island = str_replace_all(Lhirsutus$Species,"hirsutus bernieri","Island")
Lhirsutus$Island = str_replace_all(Lhirsutus$Species,"hirsutus dorreae","Island")
Shape.LhirsutsSubsp <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Island, data = Lhirsutus)

Allom.Lhirsutus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ GeoMean, data = Lhirsutus)

Lhirsutus$Age = str_replace_all(Lhirsutus$Age, "Juvenile", "Immature")
Lhirsutus$Age = str_replace_all(Lhirsutus$Age, "Subadult", "Immature")
Lhirsutus <- filter(Lhirsutus, Age != "NA")
Ontogeny.Lhirsutus <- manova(cbind(PC1, PC2, PC3, PC4, PC5, PC6) ~ Age, data = Lhirsutus)

#Summary of Small Macropod MANOVAs
SmallMacropod.Manovas <- data.frame('Taxa'= character(0),'MANOVA' = character(0), 'df1' = integer(0),'df2' = integer(0), "F Stat" = integer(0), "p"= integer(0))
SmallMacropod.Manovas[1,] <- rbind(SmallMacropod.Manovas, c("All Small Macropods","Shape ~ Age", round(summary(Ontogeny.SmallGenus)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Banded hare-wallaby","Shape ~ Size", round(summary(Allom.Lfasciatus)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Bettongia species","Shape ~ Age", round(summary(Ontogeny.Bettongia)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Brush-tailed bettong","Shape ~ Size", round(summary(Allom.Bpenicillata)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Brush-tailed bettong","Shape ~ Age", round(summary(Ontogeny.Bpenicillata)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Brush-tailed bettong","Shape ~ Sex", round(summary(Sex.Bpenicillata)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Rufous hare-wallaby","Shape ~ Sub-Species", round(summary(Shape.LhirsutsSubsp)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Rufous hare-wallaby","Shape ~ Size", round(summary(Allom.Lhirsutus)$stats[1,c(4,5,3,6)],3)))
SmallMacropod.Manovas <- rbind(SmallMacropod.Manovas, c("Rufous hare-wallaby","Shape ~ Age", round(summary(Ontogeny.Lhirsutus)$stats[1,c(4,5,3,6)],3)))
num <- as.numeric(SmallMacropod.Manovas[,3])
den <- as.numeric(SmallMacropod.Manovas[,4])
QF <- qf(0.01, num, den)
Fcritical <- SmallMacropod.Manovas[,5] > QF
SmallMacropod.Manovas <- cbind(SmallMacropod.Manovas[,1:4], Fcritical, SmallMacropod.Manovas[,5:6])
colnames(SmallMacropod.Manovas)[5] <- 'F>Fcritical at 0.01'

SmallMacropod.Manovas

remove(Allom.Bpenicillata, Allom.Lfasciatus, Allom.Lhirsutus, Bettongia, Bpenicillata, Lfasciatus, Lhirsutus, Ontogeny, Ontogeny.Bettongia, Ontogeny.Bpenicillata, Ontogeny.Lhirsutus, Ontogeny.SmallGenus, Sex.Bpenicillata, Shape.LhirsutsSubsp, SmallMacrpd, den, Fcritical, num, QF)
```

##Large Macropod - Linear Discriminant Analysis

```{r Cross Validated LDA on Form (size included) - by Genus}
Sub.train <- rbind(filter(Data.train, Size == "Large"), filter(Data.train, Group == "Northern nail-tail wallaby"))

lda.form.genus <- lda(Sub.train[,9:17], Sub.train$Genus, CV=T)
Hit.ratio <- length(which(lda.form.genus$class==Sub.train$Genus))/length(Sub.train$Genus)
Hit.ratio
CVtable.large <- table(Sub.train$Genus, lda.form.genus$class)
CVtable.large

#Hit ratio must be > Maximum Chance Criterion +25% (Ramayah et al. 2014)
tmp <- lda(Sub.train[,9:17], Sub.train$Genus, CV=F)
Cmax <- as.numeric(sort(tmp$counts, decreasing = TRUE))
Cmax <- (Cmax[1]/tmp$N)*1.25

#Hit ratio must be >= Proportional Chance Criterion (Sanchez 1974; Kovarovic et al. 2011; Ramayah et al. 2014)
Cpro <- (sum(tmp$prior^2))*1.25

#Press Q statistic (Ramayah et al. 2014)
PressQ <- ((tmp$N - ((tmp$N*Hit.ratio)*(length(tmp$lev))))^2)/((tmp$N)*((length(tmp$lev)-1)))
PressQ >= qchisq(0.01, (length(tmp$lev)-1))

CV.genus.form <- data.frame('Element'= character(0), 'Size'= character(0), 'Hit.Genus.Form'= integer(0), 'Cmax.Genus' = integer(0), 'Cpro.Genus' = integer(0), 'PressQ' = integer(0))
CV.genus.form[1,] <- rbind(CV.genus.form, c("Calcaneus", "Large", round(Hit.ratio,2), round(Cmax,2), round(Cpro,2), round(PressQ, 2)))
CV.genus.form
remove(tmp, Hit.ratio, Cmax, Cpro, PressQ)
```

```{r plot LDA.form by Genus}
lda.form.genus <- lda(Sub.train[,9:17], Sub.train$Genus, CV=F)
lda.form.train.predict <- predict(lda.form.genus)
lda.form.plot <- cbind(Sub.train[,1:8], lda.form.train.predict$x) 

chull <- lda.form.plot
polys <- ddply(chull, .(Genus), function(chull) chull[chull(chull$LD1, chull$LD2), ])

plot(lda.form.plot$LD2 ~ lda.form.plot$LD1,
     pch=largeage,
     col=largespc,
     xlab=("LD1 82.25%"),
     ylab=("LD2 13.56%"),
     asp = 1,
     cex=3)

polygon(c(polys$LD1[polys$Genus=="Macropus"]), c(polys$LD2[polys$Genus=="Macropus"]), col = alpha("#FF6633", 0.2), border = "#FF6633")
polygon(c(polys$LD1[polys$Genus=="Notamacropus"]), c(polys$LD2[polys$Genus=="Notamacropus"]), col = alpha("#0000FF", 0.2), border = "#0000FF")
polygon(c(polys$LD1[polys$Genus=="Osphranter"]), c(polys$LD2[polys$Genus=="Osphranter"]), col = alpha("#00FF00", 0.2), border = "#00FF00")
polygon(c(polys$LD1[polys$Genus=="Onychogalea"]), c(polys$LD2[polys$Genus=="Onychogalea"]), col = alpha("#FFFF00", 0.2), border = "#FFFF00")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")
remove(chull, polys)
```

```{r LD1 & LD2 Loadings LDA.form.genus}
LD_loadings <- data.frame(lda.form.genus$scaling)
barplot(LD_loadings$LD1, col = "#006600", xlab = "Measurements", ylab = "LD1 Loadings (82.25% variance)", main = "Large Macropod Calcanea - LD1 Loadings", names.arg = rownames(LD_loadings))
barplot(LD_loadings$LD2, col = "#006600", xlab = "Measurements", ylab = "LD2 Loadings (13.56% variance)", main = "Large Macropod Calcanea - LD2 Loadings", names.arg = rownames(LD_loadings))
remove(LD_loadings, lda.form.genus, lda.form.plot, lda.form.train.predict, Sub.train)
```

##Medium Macropod - Linear Discriminant Analysis
```{r Cross Validated LDA on Form (size included) - by Genus}
Sub.train <- filter(Data.train, Size == "Medium")

lda.form.genus <- lda(Sub.train[,9:17], Sub.train$Genus, CV=T)
Hit.ratio <- length(which(lda.form.genus$class==Sub.train$Genus))/length(Sub.train$Genus)
Hit.ratio
CVtable.medium <- table(Sub.train$Genus, lda.form.genus$class)
CVtable.medium

#Hit ratio must be > Maximum Chance Criterion +25% (Ramayah et al. 2014)
tmp <- lda(Sub.train[,9:17], Sub.train$Genus, CV=F)
Cmax <- as.numeric(sort(tmp$counts, decreasing = TRUE))
Cmax <- (Cmax[1]/tmp$N)*1.25

#Hit ratio must be >= Proportional Chance Criterion (Sanchez 1974; Kovarovic et al. 2011; Ramayah et al. 2014)
Cpro <- (sum(tmp$prior^2))*1.25

#Press Q statistic (Ramayah et al. 2014)
PressQ <- ((tmp$N - ((tmp$N*Hit.ratio)*(length(tmp$lev))))^2)/((tmp$N)*((length(tmp$lev)-1)))
PressQ >= qchisq(0.01, (length(tmp$lev)-1))

CV.genus.form <- rbind(CV.genus.form, c("Calcaneus", "Medium", round(Hit.ratio,2), round(Cmax,2), round(Cpro,2), round(PressQ, 2)))
CV.genus.form
remove(tmp, Hit.ratio, Cmax, Cpro, PressQ)
```

```{r Predict archaeological specimen genus membership}
Arch <- Data.arch[c(2, 3, 4),]
lda.form.genus<-lda(Sub.train[,9:17], Sub.train$Genus, CV=F) 
lda.form.train.predict <- predict(lda.form.genus)
lda.form.arch.predict <- predict(lda.form.genus, Arch[,c(9:17)])
Medium.arch.predict <- lda.form.arch.predict$posterior
Medium.arch.predict
```

```{r plot LDA.form by Genus and compare archaeological specimens}
lda.form.plot <- cbind(Sub.train[,1:8], lda.form.train.predict$x) 
tmp <- cbind(Arch[,1:8], lda.form.arch.predict$x)
lda.form.plot <- rbind(lda.form.plot, tmp)
remove(tmp)

chull <- lda.form.plot[1:61,]
polys <- ddply(chull, .(Genus), function(chull) chull[chull(chull$LD1, chull$LD2), ])

plot(lda.form.plot$LD2 ~ lda.form.plot$LD1,
     pch=mediumage,
     col=mediumspc,
     xlab=("LD1 85.85%"),
     ylab=("LD2 14.15%"),
     asp = 1,
     cex=3)

text(lda.form.plot$LD2[62:64]~lda.form.plot$LD1[62:64], labels=lda.form.plot$Specimen_ID[62:64], pos=c(1,3,2,4), cex=1.5)

polygon(c(polys$LD1[polys$Genus=="Lagorchestes"]), c(polys$LD2[polys$Genus=="Lagorchestes"]), col = alpha("#33FFFF", 0.2), border = "#33FFFF")
polygon(c(polys$LD1[polys$Genus=="Onychogalea"]), c(polys$LD2[polys$Genus=="Onychogalea"]), col = alpha("#FFFF00", 0.2), border = "#FFFF00")
polygon(c(polys$LD1[polys$Genus=="Petrogale"]), c(polys$LD2[polys$Genus=="Petrogale"]), col = alpha("#CC0066", 0.2), border = "#CC0066")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")
remove(chull, polys)
```

```{r #LD loadings lda.form.genus}
LD_loadings <- data.frame(lda.form.genus$scaling)
barplot(LD_loadings$LD1, col = "#33FFFF", xlab = "Measurements", ylab = "LD1 Loadings (85.85% variance)", main = "Medium Macropod Calcanea - LD1 Loadings", names.arg = rownames(LD_loadings))
barplot(LD_loadings$LD2, col = "#33FFFF", xlab = "Measurements", ylab = "LD2 Loadings (14.15% variance)", main = "Medium Macropod Calcanea - LD2 Loadings", names.arg = rownames(LD_loadings))

remove(Arch, LD_loadings, lda.form.genus, lda.form.plot, lda.form.train.predict, Sub.train)
```

##Small Macropod Linear Discriminant Analysis

```{r Cross Validated LDA on Form (size included) - by Genus}
Sub.train <- rbind(filter(Data.train, Size == "Small"))

lda.form.genus <- lda(Sub.train[,9:17], Sub.train$Genus, CV=T)
Hit.ratio <- length(which(lda.form.genus$class==Sub.train$Genus))/length(Sub.train$Genus)
Hit.ratio
CVtable.small <- table(Sub.train$Genus, lda.form.genus$class)
CVtable.small

#Hit ratio must be > Maximum Chance Criterion +25% (Ramayah et al. 2014)
tmp <- lda(Sub.train[,9:17], Sub.train$Genus, CV=F)
Cmax <- as.numeric(sort(tmp$counts, decreasing = TRUE))
Cmax <- (Cmax[1]/tmp$N)*1.25

#Hit ratio must be >= Proportional Chance Criterion (Sanchez 1974; Kovarovic et al. 2011; Ramayah et al. 2014)
Cpro <- (sum(tmp$prior^2))*1.25

#Press Q statistic (Ramayah et al. 2014)
PressQ <- ((tmp$N - ((tmp$N*Hit.ratio)*(length(tmp$lev))))^2)/((tmp$N)*((length(tmp$lev)-1)))
PressQ >= qchisq(0.01, (length(tmp$lev)-1))

CV.genus.form <- rbind(CV.genus.form, c("Calcaneus", "Small", round(Hit.ratio,2), round(Cmax,2), round(Cpro,2), round(PressQ, 2)))
CV.genus.form
remove(tmp, Hit.ratio, Cmax, Cpro, PressQ)
```

```{r Predict archaeological specimen genus membership}
Arch <- Data.arch[-c(2, 3, 4),]
lda.form.genus<-lda(Sub.train[,9:17], Sub.train$Genus, CV=F) 
lda.form.train.predict <- predict(lda.form.genus)
lda.form.arch.predict <- predict(lda.form.genus, Arch[,c(9:17)])
Small.arch.predict <- lda.form.arch.predict$posterior
Small.arch.predict
```

```{r plot LDA.form by Genus and compare archaeological specimens}
lda.form.plot <- cbind(Sub.train[,1:8], lda.form.train.predict$x) 
tmp <- cbind(Arch[,1:8], lda.form.arch.predict$x)
lda.form.plot <- rbind(lda.form.plot, tmp)
remove(tmp)

chull <- lda.form.plot[1:52,]
polys <- ddply(chull, .(Genus), function(chull) chull[chull(chull$LD1, chull$LD2), ])

plot(lda.form.plot$LD2 ~ lda.form.plot$LD1,
     pch=smallage,
     col=smallspc,
     xlab=("LD1 78.56%"),
     ylab=("LD2 16.54%"),
     asp = 1,
     cex=3)

text(lda.form.plot$LD2[53:56]~lda.form.plot$LD1[53:56], labels=lda.form.plot$Specimen_ID[53:56], pos=c(1,3,2,4), cex=1.5)

polygon(c(polys$LD1[polys$Genus=="Bettongia"]), c(polys$LD2[polys$Genus=="Bettongia"]), col = alpha("#666666", 0.2), border = "#666666")
polygon(c(polys$LD1[polys$Genus=="Lagorchestes"]), c(polys$LD2[polys$Genus=="Lagorchestes"]), col = alpha("#33FFFF", 0.2), border = "#33FFFF")
polygon(c(polys$LD1[polys$Genus=="Lagostrophus"]), c(polys$LD2[polys$Genus=="Lagostrophus"]), col = alpha("#339999", 0.2), border = "#339999")
polygon(c(polys$LD1[polys$Genus=="Petrogale"]), c(polys$LD2[polys$Genus=="Petrogale"]), col = alpha("#CC0066", 0.2), border = "#CC0066")

abline(v=0, lty=2, col="grey50")
abline(h=0, lty=2, col="grey50")
remove(chull, polys)
```

```{r LD1 & LD2 loadings lda.form.genus}
LD_loadings <- data.frame(lda.form.genus$scaling)
barplot(LD_loadings$LD1, col = "#666666", xlab = "Measurements", ylab = "LD1 Loadings (78.56% variance)", main = "Small Macropod Calcanea - LD1 Loadings", names.arg = rownames(LD_loadings))
barplot(LD_loadings$LD2, col = "#666666", xlab = "Measurements", ylab = "LD2 Loadings (16.54% variance)", main = "Small Macropod Calcanea - LD2 Loadings", names.arg = rownames(LD_loadings))

remove(Arch, LD_loadings, lda.form.genus, lda.form.plot, lda.form.train.predict, Sub.train)
```

##Export All Tables
```{r Table 1B Cross validated hit ratios for each skeletal element by genus and species}
write.csv(CV.genus.form, "Supp_Tables/Table.1B.csv")
```

```{r Table 2 Classification matrix for specimens from Boodie Cave}
write.csv(Medium.arch.predict, "Supp_Tables/Table.2C.csv")
write.csv(Small.arch.predict, "Supp_Tables/Table.2D.csv")
```

```{r Table S6-S8 Multivariate analysis of variance on macropod calcaneus shape}
write.csv(LargeMacropod.Manovas, "Supp_Tables/Table.S6B.csv")
write.csv(MediumMacropod.Manovas, "Supp_Tables/Table.S7B.csv")
write.csv(SmallMacropod.Manovas, "Supp_Tables/Table.S8B.csv")
```
